<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        nav { background: #333; color: white; padding: 1rem; }
        nav h1 { margin: 0; font-size: 1.5rem; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-button { margin: 5px; padding: 10px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav>
        <h1 id="navTitle">é»˜è®¤ç³»ç»Ÿåç§°</h1>
    </nav>

    <div class="test-section">
        <h2>ç³»ç»Ÿåç§°è°ƒè¯•æµ‹è¯•</h2>
        <button class="test-button" onclick="testTitleUpdate()">1. æµ‹è¯•é¡µé¢æ ‡é¢˜æ›´æ–°</button>
        <button class="test-button" onclick="testNavUpdate()">2. æµ‹è¯•å¯¼èˆªæ æ›´æ–°</button>
        <button class="test-button" onclick="testAPIUpdate()">3. æµ‹è¯•APIæ›´æ–°</button>
        <button class="test-button" onclick="checkElements()">4. æ£€æŸ¥DOMå…ƒç´ </button>
        <div class="result" id="testResult">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="test-section">
        <h2>å®æ—¶çŠ¶æ€ç›‘æ§</h2>
        <p>é¡µé¢æ ‡é¢˜: <span id="pageTitle">-</span></p>
        <p>å¯¼èˆªæ æ ‡é¢˜: <span id="navStatus">-</span></p>
        <p>localStorage: <span id="localStorageStatus">-</span></p>
        <p>æœ€åæ›´æ–°: <span id="lastUpdate">-</span></p>
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>

    <script>
        let testCount = 0;

        // æ›´æ–°å®æ—¶çŠ¶æ€
        function updateStatus() {
            document.getElementById('pageTitle').textContent = document.title;

            const navTitle = document.getElementById('navTitle');
            document.getElementById('navStatus').textContent = navTitle ? navTitle.textContent : 'å…ƒç´ æœªæ‰¾åˆ°';

            document.getElementById('localStorageStatus').textContent = localStorage.getItem('systemName') || 'æœªè®¾ç½®';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // æµ‹è¯•é¡µé¢æ ‡é¢˜æ›´æ–°
        function testTitleUpdate() {
            testCount++;
            const newTitle = `æµ‹è¯•æ ‡é¢˜ ${testCount} - ${new Date().getSeconds()}`;
            document.title = newTitle;

            showResult(`âœ… é¡µé¢æ ‡é¢˜å·²æ›´æ–°ä¸º: ${newTitle}`);
            updateStatus();
        }

        // æµ‹è¯•å¯¼èˆªæ æ›´æ–°
        function testNavUpdate() {
            testCount++;
            const newNavTitle = `æµ‹è¯•å¯¼èˆªæ  ${testCount}`;
            const navTitle = document.getElementById('navTitle');

            if (navTitle) {
                navTitle.textContent = newNavTitle;
                showResult(`âœ… å¯¼èˆªæ æ ‡é¢˜å·²æ›´æ–°ä¸º: ${newNavTitle}`);
            } else {
                showResult(`âŒ å¯¼èˆªæ å…ƒç´ æœªæ‰¾åˆ°`);
            }

            updateStatus();
        }

        // æµ‹è¯•APIæ›´æ–°
        async function testAPIUpdate() {
            testCount++;
            const newName = `APIæµ‹è¯•ç³»ç»Ÿ ${testCount}`;

            try {
                const response = await window.API.service.put('/settings/general', {
                    systemName: newName
                });

                // ç«‹å³åº”ç”¨åˆ°å‰ç«¯
                document.title = `ç®€å•è°ƒè¯•é¡µé¢ - ${newName}`;
                const navTitle = document.getElementById('navTitle');
                if (navTitle) {
                    navTitle.textContent = newName;
                }
                localStorage.setItem('systemName', newName);

                showResult(`âœ… APIæ›´æ–°æˆåŠŸ: ${newName}`);

            } catch (error) {
                showResult(`âŒ APIæ›´æ–°å¤±è´¥: ${error.message}`);
            }

            updateStatus();
        }

        // æ£€æŸ¥DOMå…ƒç´ 
        function checkElements() {
            const checks = {
                'nav h1': !!document.querySelector('nav h1'),
                '#navTitle': !!document.getElementById('navTitle'),
                'document.title': !!document.title,
                'localStorage': !!localStorage.getItem('systemName')
            };

            let result = 'DOMå…ƒç´ æ£€æŸ¥ç»“æœ:\n';
            for (const [selector, found] of Object.entries(checks)) {
                result += `  ${selector}: ${found ? 'âœ…' : 'âŒ'}\n`;
            }

            showResult(result);
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(message) {
            const resultDiv = document.getElementById('testResult');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML = `<strong>[${timestamp}]</strong>\n${message}`;
            console.log(`[${timestamp}] ${message}`);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            updateStatus();
            showResult('ğŸš€ è°ƒè¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª');
        });

        // æ¯ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>