<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·æ•°æ®ç®¡ç† - å¹²ç»†èƒæ²»ç–—æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</title>
    <link href="css/tailwind.css" rel="stylesheet">
    <link href="css/fontawesome.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-dna text-2xl"></i>
                    <h1 class="text-xl md:text-2xl font-bold">å¹²ç»†èƒæ²»ç–—æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="dashboard.html" class="nav-link hover:text-blue-200 transition-colors">
                        <i class="fas fa-chart-line mr-2"></i>ä»ªè¡¨æ¿
                    </a>
                    <a href="customers.html" class="nav-link hover:text-blue-200 transition-colors">
                        <i class="fas fa-users mr-2"></i>æ£€å®¢ç®¡ç†
                    </a>
                    <a href="health-data.html" class="nav-link hover:text-blue-200 transition-colors text-blue-200">
                        <i class="fas fa-heartbeat mr-2"></i>å¥åº·æ•°æ®
                    </a>
                    <a href="stem-cell.html" class="nav-link hover:text-blue-200 transition-colors">
                        <i class="fas fa-microscope mr-2"></i>å¹²ç»†èƒç®¡ç†
                    </a>
                    <a href="reports.html" class="nav-link hover:text-blue-200 transition-colors">
                        <i class="fas fa-file-medical mr-2"></i>æŠ¥å‘ŠæŸ¥çœ‹
                    </a>
                    <a href="statistics.html" class="nav-link hover:text-blue-200 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>ç»Ÿè®¡åˆ†æ
                    </a>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 hover:text-blue-200 transition-colors">
                            <i class="fas fa-user-circle"></i>
                            <span id="username">ç”¨æˆ·</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user mr-2"></i>ä¸ªäººèµ„æ–™
                            </a>
                            <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i>ç³»ç»Ÿè®¾ç½®
                            </a>
                            <div id="adminMenuItems" class="hidden border-t border-gray-200">
                                <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    ç®¡ç†å‘˜å·¥å…·
                                </div>
                                <button onclick="showDepartmentManagementModal()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-hospital mr-2"></i>ç§‘å®¤ç®¡ç†
                                </button>
                                <button onclick="showTreatmentTypeMaintenance()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-chart-pie mr-2"></i>æ²»ç–—ç±»å‹ç»´æŠ¤
                                </button>
                                <button onclick="showDiseaseTypeMaintenance()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-notes-medical mr-2"></i>ç—…ç§åˆ†å¸ƒç»´æŠ¤
                                </button>
                            </div>
                            <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                            </button>
                        </div>
                    </div>
                </div>
                <button id="mobileMenuBtn" class="md:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">å¥åº·æ•°æ®ç®¡ç†</h2>
            <p class="text-gray-600">å½•å…¥å’Œç®¡ç†æ£€å®¢çš„ä½“æ£€è¯„ä¼°æ•°æ®å’ŒåŒ»å­¦å½±åƒ</p>
        </div>

        <!-- æ“ä½œæµç¨‹æç¤º -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-3 text-xl"></i>
                <div>
                    <h4 class="text-blue-900 font-semibold mb-1">æ“ä½œæµç¨‹è¯´æ˜</h4>
                    <p class="text-blue-800 text-sm">è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š<strong>1ï¸âƒ£ é€‰æ‹©ç§‘å®¤ç±»å‹</strong> â†’ <strong>2ï¸âƒ£ é€‰æ‹©æ£€å®¢å’Œç§‘å®¤</strong> â†’ <strong>3ï¸âƒ£ è°ƒé˜…ä½“æ£€ä¿¡æ¯</strong></p>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢</h3>
                <button onclick="refreshTodayCustomers()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èº«ä»½è¯å·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ€§åˆ«</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¹´é¾„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è”ç³»ç”µè¯</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="todayCustomersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- ä»Šæ—¥æ£€å®¢æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                <div id="noTodayCustomersMessage" class="hidden p-8 text-center text-gray-500">
                    <i class="fas fa-user-clock text-4xl mb-4"></i>
                    <p>ä»Šæ—¥æš‚æ— æ–°å¢ä½“æ£€æ£€å®¢</p>
                </div>
            </div>
        </div>

        <!-- å¥åº·æ•°æ®å½•å…¥åŒºåŸŸ -->
        <div id="healthDataEntryArea">
            <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ç§‘å®¤ç±»å‹ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <span class="text-blue-600 mr-2">1ï¸âƒ£</span>é€‰æ‹©ç§‘å®¤ç±»å‹
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="selectDepartmentType('laboratory')" class="department-type-btn bg-yellow-100 text-yellow-700 p-4 rounded-lg hover:bg-yellow-200 transition-colors text-center">
                        <i class="fas fa-vial text-2xl mb-2"></i>
                        <p class="font-medium">æ£€éªŒç§‘</p>
                        <p class="text-xs text-yellow-600 mt-1">æ£€éªŒç»“æœã€å‚è€ƒå€¼ã€å¼‚å¸¸çŠ¶æ€</p>
                    </button>
                    <button onclick="selectDepartmentType('general')" class="department-type-btn bg-green-100 text-green-700 p-4 rounded-lg hover:bg-green-200 transition-colors text-center">
                        <i class="fas fa-stethoscope text-2xl mb-2"></i>
                        <p class="font-medium">å¸¸è§„ç§‘å®¤</p>
                        <p class="text-xs text-green-600 mt-1">é¡¹ç›®åç§°ã€é¡¹ç›®ç»“æœ</p>
                    </button>
                    <button onclick="selectDepartmentType('imaging')" class="department-type-btn bg-purple-100 text-purple-700 p-4 rounded-lg hover:bg-purple-200 transition-colors text-center">
                        <i class="fas fa-x-ray text-2xl mb-2"></i>
                        <p class="font-medium">å½±åƒç§‘å®¤</p>
                        <p class="text-xs text-purple-600 mt-1">æ£€æŸ¥æè¿°ã€æ£€æŸ¥ç»“è®º</p>
                    </button>
                    <button onclick="selectDepartmentType('instrument')" class="department-type-btn bg-blue-100 text-blue-700 p-4 rounded-lg hover:bg-blue-200 transition-colors text-center">
                        <i class="fas fa-microscope text-2xl mb-2"></i>
                        <p class="font-medium">ä»ªå™¨å®¤</p>
                        <p class="text-xs text-blue-600 mt-1">æ£€æŸ¥ç»“æœã€åŒ»ç”Ÿ</p>
                    </button>
                </div>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ£€å®¢å’Œç§‘å®¤ -->
            <div id="customerAndDepartmentSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <span class="text-blue-600 mr-2">2ï¸âƒ£</span>é€‰æ‹©æ£€å®¢ä¿¡æ¯
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ£€å®¢é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ£€å®¢ <span class="text-red-500">*</span></label>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="customerIdentityCard"
                                placeholder="è¯·è¾“å…¥èº«ä»½è¯å·æŸ¥æ‰¾æ£€å®¢"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                readonly
                            >
                            <button
                                type="button"
                                onclick="customerLookup.showLookupModal({
                                    title: 'æŸ¥æ‰¾æ£€å®¢æ¡£æ¡ˆ',
                                    operationType: 'HealthAssessment',
                                    onSuccess: handleCustomerSelect
                                })"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                <i class="fas fa-search mr-2"></i>æŸ¥æ‰¾
                            </button>
                        </div>
                        <div id="selectedCustomerInfo" class="mt-2 hidden">
                            <!-- é€‰ä¸­çš„æ£€å®¢ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>

                    <!-- ç§‘å®¤é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç§‘å®¤ <span class="text-red-500">*</span></label>
                        <select id="departmentSelect" onchange="onDepartmentChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">è¯·é€‰æ‹©ç§‘å®¤</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ­¥ï¼šä½“æ£€IDè°ƒé˜… -->
            <div id="examIdSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <span class="text-blue-600 mr-2">3ï¸âƒ£</span>ä½“æ£€ä¿¡æ¯è°ƒé˜…
                </h3>
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½“æ£€ID <span class="text-red-500">*</span></label>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="medicalExamId"
                                placeholder="è¯·è¾“å…¥ä½“æ£€IDï¼ˆå”¯ä¸€ï¼‰"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                oninput="updateLookupExamButton()"
                                required
                            >
                            <button
                                type="button"
                                onclick="lookupExaminationData()"
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                title="è°ƒé˜…ä½“æ£€ä¿¡æ¯"
                                id="lookupExamBtn"
                                disabled
                            >
                                <i class="fas fa-search mr-2"></i>è°ƒé˜…ä½“æ£€ä¿¡æ¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ£€éªŒç§‘æ•°æ®å½•å…¥è¡¨å• -->
            <div id="labDataForm" class="health-data-form hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">æ£€éªŒæ•°æ®å½•å…¥</h3>
                <form id="labHealthForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ£€éªŒæ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="examDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ£€éªŒé¡¹ç›®åˆ—è¡¨</label>
                        <div id="labTestItems" class="space-y-3">
                            <!-- æ£€éªŒé¡¹ç›®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>
                        <button type="button" onclick="addLabTestItem()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>æ·»åŠ æ£€éªŒé¡¹ç›®
                        </button>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="getHealthResults()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>è·å–ä½“æ£€ç»“æœ
                        </button>
                        <button type="button" onclick="clearLabForm()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>æ¸…ç©º
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>

            <!-- å¸¸è§„ç§‘å®¤æ•°æ®å½•å…¥è¡¨å• -->
            <div id="generalDataForm" class="health-data-form hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">å¸¸è§„ç§‘å®¤æ•°æ®å½•å…¥</h3>
                <form id="generalHealthForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¯„ä¼°æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="assessmentDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŒ»ç”Ÿ</label>
                            <input type="text" id="generalDoctorName" placeholder="è¯·è¾“å…¥åŒ»ç”Ÿå§“å" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯„ä¼°é¡¹ç›®åˆ—è¡¨</label>
                        <div id="generalAssessmentItems" class="space-y-3">
                            <!-- è¯„ä¼°é¡¹ç›®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>
                        <button type="button" onclick="addGeneralAssessmentItem()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>æ·»åŠ è¯„ä¼°é¡¹ç›®
                        </button>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="getHealthResults()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>è·å–ä½“æ£€ç»“æœ
                        </button>
                        <button type="button" onclick="clearGeneralForm()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>æ¸…ç©º
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>

            <!-- å½±åƒç§‘å®¤æ•°æ®å½•å…¥è¡¨å• -->
            <div id="imagingDataForm" class="health-data-form hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">å½±åƒç§‘å®¤æ•°æ®å½•å…¥</h3>
                <form id="imagingHealthForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="examDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŒ»ç”Ÿ <span class="text-red-500">*</span></label>
                            <input type="text" id="imagingDoctorName" required placeholder="è¯·è¾“å…¥åŒ»ç”Ÿå§“å" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥æè¿° <span class="text-red-500">*</span></label>
                        <textarea id="examDescription" rows="6" required placeholder="è¯·è¾“å…¥è¯¦ç»†çš„æ£€æŸ¥æè¿°..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥ç»“è®º <span class="text-red-500">*</span></label>
                        <textarea id="examConclusion" rows="4" required placeholder="è¯·è¾“å…¥æ£€æŸ¥ç»“è®º..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="getHealthResults()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>è·å–ä½“æ£€ç»“æœ
                        </button>
                        <button type="button" onclick="clearImagingForm()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>æ¸…ç©º
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>

            <!-- ä»ªå™¨å®¤æ•°æ®å½•å…¥è¡¨å• -->
            <div id="instrumentDataForm" class="health-data-form hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ä»ªå™¨å®¤æ•°æ®å½•å…¥</h3>
                <form id="instrumentHealthForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="instrumentDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŒ»ç”Ÿ <span class="text-red-500">*</span></label>
                            <input type="text" id="instrumentDoctor" required placeholder="è¯·è¾“å…¥åŒ»ç”Ÿå§“å" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥ç»“æœ <span class="text-red-500">*</span></label>
                        <textarea id="instrumentResult" rows="8" required placeholder="è¯·è¾“å…¥æ£€æŸ¥ç»“æœ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="getHealthResults()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>è·å–ä½“æ£€ç»“æœ
                        </button>
                        <button type="button" onclick="clearInstrumentForm()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>æ¸…ç©º
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Â© 2025 å¹²ç»†èƒæ²»ç–—æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        </div>
    </footer>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modalContainer"></div>
    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer"></div>

    <!-- ç§‘å®¤ç®¡ç†å¼¹å‡ºå±‚ -->
    <div id="departmentManagementModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-4 mx-auto p-5 border w-11/12 max-w-7xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-xl font-semibold text-gray-900">ç§‘å®¤ç®¡ç†</h3>
                <button type="button" onclick="closeDepartmentManagementModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="max-h-screen overflow-y-auto">
                <iframe id="departmentManagementFrame" src="department-management.html" class="w-full h-screen border-0"></iframe>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/customerLookup.js"></script>

    <script>
        // æ˜¾ç¤ºç§‘å®¤ç®¡ç†å¼¹å‡ºå±‚
        function showDepartmentManagementModal() {
            document.getElementById('departmentManagementModal').classList.remove('hidden');
            // å…³é—­ç”¨æˆ·èœå•
            document.getElementById('userMenu').classList.add('hidden');
        }

        // å…³é—­ç§‘å®¤ç®¡ç†å¼¹å‡ºå±‚
        function closeDepartmentManagementModal() {
            document.getElementById('departmentManagementModal').classList.add('hidden');
        }

        // ç‚¹å‡»å¼¹å‡ºå±‚å¤–éƒ¨å…³é—­
        document.getElementById('departmentManagementModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDepartmentManagementModal();
            }
        });

        // ESCé”®å…³é—­å¼¹å‡ºå±‚
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDepartmentManagementModal();
            }
        });

        // æ˜¾ç¤ºæ²»ç–—ç±»å‹ç»´æŠ¤å¼¹å‡ºå±‚
        function showTreatmentTypeMaintenance() {
            // å…³é—­ç”¨æˆ·èœå•
            document.getElementById('userMenu').classList.add('hidden');
            // è·³è½¬åˆ°å¹²ç»†èƒé¡µé¢å¹¶è§¦å‘ç»´æŠ¤åŠŸèƒ½
            window.location.href = 'stem-cell.html?show=treatment-maintenance';
        }

        // æ˜¾ç¤ºç—…ç§åˆ†å¸ƒç»´æŠ¤å¼¹å‡ºå±‚
        function showDiseaseTypeMaintenance() {
            // å…³é—­ç”¨æˆ·èœå•
            document.getElementById('userMenu').classList.add('hidden');
            // è·³è½¬åˆ°å¹²ç»†èƒé¡µé¢å¹¶è§¦å‘ç»´æŠ¤åŠŸèƒ½
            window.location.href = 'stem-cell.html?show=disease-maintenance';
        }

        // å¤„ç†æ£€å®¢é€‰æ‹©
        function handleCustomerSelect(customerData) {
            const { customerInfo } = customerData;

            // å®‰å…¨åœ°è·å–å­—æ®µå€¼ï¼Œå¤„ç†ä¸åŒçš„å­—æ®µåæ ¼å¼
            const identityCard = customerInfo.identityCard || customerInfo.IdentityCard || '';
            const name = customerInfo.name || customerInfo.Name || 'æœªçŸ¥';
            const gender = customerInfo.gender || customerInfo.Gender || '';
            const age = customerInfo.age || customerInfo.Age || '';
            const customerId = customerInfo.id || customerInfo.ID;

            // å¡«å……èº«ä»½è¯å·
            document.getElementById('customerIdentityCard').value = identityCard;

            // æ˜¾ç¤ºé€‰ä¸­çš„æ£€å®¢ä¿¡æ¯
            const infoDiv = document.getElementById('selectedCustomerInfo');
            infoDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <div class="flex-1">
                            <span class="font-medium text-green-800">${name}</span>
                            <span class="text-gray-500 ml-2">${gender}</span>
                            <span class="text-gray-500 ml-2">${age || ''}å²</span>
                        </div>
                        <button
                            type="button"
                            onclick="clearCustomerSelection()"
                            class="text-red-500 hover:text-red-700"
                            title="æ¸…é™¤é€‰æ‹©"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            infoDiv.classList.remove('hidden');

            // å­˜å‚¨æ£€å®¢IDå’Œèº«ä»½è¯å·ç”¨äºè¡¨å•æäº¤
            window.selectedCustomerId = customerId;
            window.selectedCustomerIdentityCard = identityCard;

            // æ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€
            updateLookupExamButton();

            showNotification('success', `å·²é€‰æ‹©æ£€å®¢ï¼š${name}`);
        }

        // æ¸…é™¤æ£€å®¢é€‰æ‹©
        function clearCustomerSelection() {
            document.getElementById('customerIdentityCard').value = '';
            document.getElementById('selectedCustomerInfo').classList.add('hidden');
            window.selectedCustomerId = null;
        }

        // é€‰æ‹©ç§‘å®¤ç±»å‹
        function selectDepartmentType(type) {
            window.selectedDepartmentType = type;

            // æ˜¾ç¤ºæ•°æ®å½•å…¥åŒºåŸŸ
            document.getElementById('healthDataEntryArea').classList.remove('hidden');

            // éšè—æ‰€æœ‰è¡¨å•
            document.querySelectorAll('.health-data-form').forEach(form => {
                form.classList.add('hidden');
            });

            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            document.querySelectorAll('.department-type-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });

            // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
            event.target.closest('.department-type-btn').classList.add('ring-2', 'ring-blue-500');

            // æ˜¾ç¤ºç¬¬äºŒæ­¥åŒºåŸŸï¼ˆæ£€å®¢å’Œç§‘å®¤é€‰æ‹©ï¼‰
            document.getElementById('customerAndDepartmentSection').classList.remove('hidden');
            document.getElementById('examIdSection').classList.remove('hidden');

            // åŠ è½½å¯¹åº”ç±»å‹çš„ç§‘å®¤åˆ—è¡¨
            loadDepartmentsByType(type);

            // æ˜¾ç¤ºå¯¹åº”çš„è¡¨å•
            switch(type) {
                case 'laboratory':
                    document.getElementById('labDataForm').classList.remove('hidden');
                    break;
                case 'general':
                    document.getElementById('generalDataForm').classList.remove('hidden');
                    break;
                case 'imaging':
                    document.getElementById('imagingDataForm').classList.remove('hidden');
                    break;
                case 'instrument':
                    document.getElementById('instrumentDataForm').classList.remove('hidden');
                    break;
            }

            // æ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€
            updateLookupExamButton();
        }

        // æ ¹æ®ç±»å‹åŠ è½½ç§‘å®¤åˆ—è¡¨
        async function loadDepartmentsByType(type) {
            try {
                const response = await api.get(`/departments?type=${type}`);
                if (response.success) {
                    const select = document.getElementById('departmentSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç§‘å®¤</option>';

                    response.data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.Name;
                        // æ·»åŠ ç§‘å®¤ç¼–ç ä½œä¸ºdataå±æ€§ï¼Œå¸¸è§„ç§‘å®¤ã€å½±åƒç§‘å®¤å’Œä»ªå™¨å®¤éœ€è¦ä½¿ç”¨
                        if (dept.Code && (type === 'general' || type === 'imaging' || type === 'instrument')) {
                            option.setAttribute('data-ksbm', dept.Code);
                        }
                        select.appendChild(option);
                    });

                    // ç§‘å®¤åˆ—è¡¨åŠ è½½å®Œæˆåï¼Œæ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœç”¨æˆ·å·²ç»é€‰æ‹©äº†æ£€å®¢ï¼‰
                    updateLookupExamButton();
                } else {
                    console.error('åŠ è½½ç§‘å®¤åˆ—è¡¨å¤±è´¥:', response.message);
                    NotificationHelper.error(response.message || 'æ— æ³•åŠ è½½ç§‘å®¤åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'æ•°æ®åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç§‘å®¤åˆ—è¡¨å¤±è´¥:', error);
                NotificationHelper.networkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•åŠ è½½ç§‘å®¤åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•', () => {
                    loadDepartmentsByType(type); // é‡è¯•å‡½æ•°
                });
            }
        }

        // ç§‘å®¤å˜æ›´äº‹ä»¶
        function onDepartmentChange() {
            // è¿™é‡Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„ç§‘å®¤åŠ è½½ç›¸åº”çš„è¡¨å•æ¨¡æ¿
            console.log('ç§‘å®¤å·²å˜æ›´');
            // æ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€
            updateLookupExamButton();
        }

        // æ·»åŠ æ£€éªŒé¡¹ç›®
        function addLabTestItem() {
            const container = document.getElementById('labTestItems');
            const itemId = 'lab_' + Date.now();

            const itemHtml = `
                <div id="${itemId}" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-700">æ£€éªŒé¡¹ç›®</h4>
                        <button type="button" onclick="removeLabTestItem('${itemId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">æ£€éªŒåç§° <span class="text-red-500">*</span></label>
                            <input type="text" name="testName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: è¡€å¸¸è§„">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">æ£€éªŒç»“æœ <span class="text-red-500">*</span></label>
                            <input type="text" name="testResult" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: 4.5">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">å‚è€ƒå€¼</label>
                            <input type="text" name="referenceValue" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: 3.5-9.5">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">å¼‚å¸¸çŠ¶æ€</label>
                            <select name="abnormalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="0">æ­£å¸¸</option>
                                <option value="1">åä½</option>
                                <option value="2">åé«˜</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">å•ä½</label>
                            <input type="text" name="unit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: 10^9/L">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">æ£€æŸ¥åŒ»ç”Ÿ</label>
                            <input type="text" name="doctor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: å¼ åŒ»ç”Ÿ">
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', itemHtml);
        }

        // ç§»é™¤æ£€éªŒé¡¹ç›®
        function removeLabTestItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
            }
        }

        // æ·»åŠ å¸¸è§„è¯„ä¼°é¡¹ç›®
        function addGeneralAssessmentItem() {
            const container = document.getElementById('generalAssessmentItems');
            const itemId = 'general_' + Date.now();

            const itemHtml = `
                <div id="${itemId}" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-700">è¯„ä¼°é¡¹ç›®</h4>
                        <button type="button" onclick="removeGeneralAssessmentItem('${itemId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">é¡¹ç›®åç§° <span class="text-red-500">*</span></label>
                            <input type="text" name="itemName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: è¡€å‹">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">é¡¹ç›®ç»“æœ <span class="text-red-500">*</span></label>
                            <input type="text" name="itemResult" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚: 120/80 mmHg">
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', itemHtml);
        }

        // ç§»é™¤å¸¸è§„è¯„ä¼°é¡¹ç›®
        function removeGeneralAssessmentItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
            }
        }

        // è·å–ä½“æ£€ç»“æœ
        async function getHealthResults() {
            // éªŒè¯æ£€å®¢æ˜¯å¦å·²é€‰æ‹©
            if (!window.selectedCustomerId) {
                NotificationHelper.validationError('è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©æˆ–æŸ¥æ‰¾æ£€å®¢ä¿¡æ¯ï¼Œç„¶åæ‰èƒ½è·å–ä½“æ£€ç»“æœ');
                return;
            }

            const selectedDepartment = window.selectedDepartmentType;
            if (selectedDepartment !== 'laboratory' && selectedDepartment !== 'general' && selectedDepartment !== 'imaging' && selectedDepartment !== 'instrument') {
                showNotification('info', 'ç›®å‰ä»…æ”¯æŒæ£€éªŒç§‘ã€å¸¸è§„ç§‘å®¤ã€å½±åƒç§‘å®¤å’Œä»ªå™¨å®¤æ•°æ®è·å–');
                return;
            }

            // è·å–ä½“æ£€ID
            const examId = document.getElementById('medicalExamId').value;
            if (!examId) {
                NotificationHelper.validationError('è¯·å…ˆé€šè¿‡è°ƒé˜…æŒ‰é’®é€‰æ‹©ä½“æ£€IDï¼Œæˆ–åœ¨è¾“å…¥æ¡†ä¸­æ‰‹åŠ¨è¾“å…¥ä½“æ£€ID');
                return;
            }

            // è·å–é€‰ä¸­çš„ç§‘å®¤
            const departmentSelect = document.getElementById('departmentSelect');
            const selectedDepartmentOption = departmentSelect.options[departmentSelect.selectedIndex];
            const ksbm = selectedDepartmentOption ? selectedDepartmentOption.getAttribute('data-ksbm') : null;

            if ((selectedDepartment === 'general' || selectedDepartment === 'imaging' || selectedDepartment === 'instrument') && !ksbm) {
                NotificationHelper.validationError('è¯·å…ˆé€‰æ‹©å…·ä½“çš„ç§‘å®¤ï¼Œä»¥ä¾¿è·å–å¯¹åº”çš„ç§‘å®¤ç¼–ç ');
                return;
            }

            const departmentName = selectedDepartment === 'laboratory' ? 'æ£€éªŒç§‘' :
                              selectedDepartment === 'general' ? 'å¸¸è§„ç§‘å®¤' :
                              selectedDepartment === 'imaging' ? 'å½±åƒç§‘å®¤' : 'ä»ªå™¨å®¤';
            const loadingNotification = NotificationHelper.loading(`æ­£åœ¨ä»${departmentName}ç³»ç»Ÿè·å–æ•°æ®ï¼Œè¯·ç¨å€™...`);

            try {
                let result;

                if (selectedDepartment === 'laboratory') {
                    // å¼ºåˆ¶æ¸…ç©ºæ£€éªŒé¡¹ç›®å®¹å™¨ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™æ•°æ®
                    const container = document.getElementById('labTestItems');
                    if (container) {
                        container.innerHTML = '';
                        // å½»åº•ç§»é™¤æ‰€æœ‰å­å…ƒç´ 
                        while (container.firstChild) {
                            container.removeChild(container.firstChild);
                        }
                    }

                    // è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–æ£€éªŒç§‘æ•°æ®
                    const response = await fetch(`${window.EXAMINATION_API_CONFIG.baseURL}/query_laboratory`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.EXAMINATION_API_CONFIG.headers
                        },
                        body: JSON.stringify({
                            studyId: examId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    result = await response.json();

                    if (result.code === 200 && result.data) {
                        NotificationHelper.success(`æˆåŠŸè·å– ${result.data.length} é¡¹æ£€éªŒæ•°æ®ï¼Œå·²è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ä¸­`, 'æ•°æ®è·å–æˆåŠŸ');
                        console.log('ğŸ“‹ æ£€éªŒç§‘æ•°æ®:', result.data);
                        console.log('ğŸ“‹ åŸå§‹æ•°æ®è¯¦ç»†ç»“æ„:');
                        result.data.forEach((item, index) => {
                            console.log(`  ${index + 1}. ç»„åˆé¡¹ç›®: ${item.SFXMMC}, å­é¡¹ç›®: ${item.XXMC}, ç»“æœ: ${item.ItemResult}, å•ä½: "${item.ItemUnit}"`,
                                           `æ£€æŸ¥æ—¥æœŸ: ${item.CheckDate}, åŒ»ç”Ÿ: ${item.Doctor}, çŠ¶æ€æ ‡è®°: ${item.Flag}`);
                        });
                        console.log('ğŸ“… æ£€éªŒæ—¥æœŸ(tjrq):', result.tjrq);

                        // å°†æ•°æ®å’Œæ£€éªŒæ—¥æœŸä¸€èµ·å¡«å……åˆ°è¡¨å•ä¸­
                        fillLaboratoryDataForm(result.data, result.tjrq);
                    } else {
                        NotificationHelper.warning(result.message || 'è¯¥ä½“æ£€IDæœªæ‰¾åˆ°å¯¹åº”çš„æ£€éªŒæ•°æ®ï¼Œè¯·æ£€æŸ¥ä½“æ£€IDæ˜¯å¦æ­£ç¡®', 'æ•°æ®æœªæ‰¾åˆ°');
                    }
                } else if (selectedDepartment === 'general') {
                    // å¼ºåˆ¶æ¸…ç©ºå¸¸è§„ç§‘å®¤é¡¹ç›®å®¹å™¨ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™æ•°æ®
                    const container = document.getElementById('generalAssessmentItems');
                    if (container) {
                        container.innerHTML = '';
                        // å½»åº•ç§»é™¤æ‰€æœ‰å­å…ƒç´ 
                        while (container.firstChild) {
                            container.removeChild(container.firstChild);
                        }
                    }

                    // è°ƒç”¨å¸¸è§„ç§‘å®¤APIè·å–æ•°æ®
                    result = await window.API.generalDepartment.queryGeneralDepartment(examId, ksbm);

                    if (result.code === 200 && result.data) {
                        NotificationHelper.success(`æˆåŠŸè·å–å¸¸è§„ç§‘å®¤æ•°æ®ï¼Œå·²è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ä¸­`, 'æ•°æ®è·å–æˆåŠŸ');
                        console.log('ğŸ“‹ å¸¸è§„ç§‘å®¤æ•°æ®:', result.data);
                        console.log('ğŸ“‹ åŸå§‹æ•°æ®è¯¦ç»†ç»“æ„:');
                        result.data.forEach((item, index) => {
                            console.log(`  ${index + 1}. StudyID: ${item.StudyID}, åŒ…å«å­—æ®µæ•°é‡: ${Object.keys(item).length}`);
                            Object.keys(item).forEach(key => {
                                if (key !== 'StudyID' && item[key] !== null && item[key] !== '') {
                                    console.log(`    - ${key}: ${item[key]}`);
                                }
                            });
                        });

                        // å¡«å……åŒ»ç”Ÿå­—æ®µ
                        if (result.åŒ»ç”Ÿ) {
                            const doctorInput = document.getElementById('generalDoctorName');
                            if (doctorInput) {
                                doctorInput.value = result.åŒ»ç”Ÿ;
                                console.log('ğŸ‘¨â€âš•ï¸ å·²å¡«å……å¸¸è§„ç§‘å®¤åŒ»ç”Ÿå§“å:', result.åŒ»ç”Ÿ);
                            }
                        }

                        // å°†æ•°æ®å¡«å……åˆ°å¸¸è§„ç§‘å®¤è¡¨å•ä¸­
                        fillGeneralDepartmentForm(result.data);
                    } else {
                        NotificationHelper.warning(result.message || 'è¯¥ä½“æ£€IDæœªæ‰¾åˆ°å¯¹åº”çš„å¸¸è§„ç§‘å®¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ä½“æ£€IDæ˜¯å¦æ­£ç¡®', 'æ•°æ®æœªæ‰¾åˆ°');
                    }
                } else if (selectedDepartment === 'imaging') {
                    // è°ƒç”¨å½±åƒç§‘å®¤APIè·å–æ•°æ®
                    result = await window.API.imagingDepartment.queryImagingDepartment(examId, ksbm);

                    if (result.code === 200 && result.data) {
                        NotificationHelper.success(`æˆåŠŸè·å–å½±åƒç§‘å®¤æ•°æ®ï¼Œå·²è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ä¸­`, 'æ•°æ®è·å–æˆåŠŸ');
                        console.log('ğŸ“‹ å½±åƒç§‘å®¤æ•°æ®:', result.data);
                        console.log('ğŸ“‹ åŸå§‹æ•°æ®è¯¦ç»†ç»“æ„:');
                        result.data.forEach((item, index) => {
                            console.log(`  ${index + 1}. StudyID: ${item.StudyID}, Doctor: ${item.Doctor}`);
                            console.log(`    - æ£€æŸ¥æè¿°é•¿åº¦: ${item['æ£€æŸ¥æè¿°'] ? item['æ£€æŸ¥æè¿°'].length : 0} å­—ç¬¦`);
                            console.log(`    - æ£€æŸ¥ç»“è®ºé•¿åº¦: ${item['æ£€æŸ¥ç»“è®º'] ? item['æ£€æŸ¥ç»“è®º'].length : 0} å­—ç¬¦`);
                        });
                        console.log('ğŸ“… ä½“æ£€æ—¥æœŸ(tjrq):', result.tjrq);

                        // å°†æ•°æ®å¡«å……åˆ°å½±åƒç§‘å®¤è¡¨å•ä¸­
                        fillImagingDepartmentForm(result.data, result.tjrq);
                    } else {
                        NotificationHelper.warning(result.message || 'è¯¥ä½“æ£€IDæœªæ‰¾åˆ°å¯¹åº”çš„å½±åƒç§‘å®¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ä½“æ£€IDæ˜¯å¦æ­£ç¡®', 'æ•°æ®æœªæ‰¾åˆ°');
                    }
                } else if (selectedDepartment === 'instrument') {
                    // è°ƒç”¨ä»ªå™¨å®¤APIè·å–æ•°æ®
                    result = await window.API.instrumentRoom.queryInstrumentRoom(examId, ksbm);

                    if (result.code === 200 && result.data) {
                        NotificationHelper.success(`æˆåŠŸè·å–ä»ªå™¨å®¤æ•°æ®ï¼Œå·²è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ä¸­`, 'æ•°æ®è·å–æˆåŠŸ');
                        console.log('ğŸ“‹ ä»ªå™¨å®¤æ•°æ®:', result.data);
                        console.log('ğŸ“‹ åŸå§‹æ•°æ®è¯¦ç»†ç»“æ„:');
                        result.data.forEach((item, index) => {
                            console.log(`  ${index + 1}. StudyID: ${item.StudyID}, æ£€æŸ¥ç»“æœ: ${item['æ£€æŸ¥ç»“æœ']}`);
                        });
                        console.log('ğŸ“… ä½“æ£€æ—¥æœŸ(tjrq):', result.tjrq);

                        // å°†æ•°æ®å¡«å……åˆ°ä»ªå™¨å®¤è¡¨å•ä¸­
                        fillInstrumentRoomForm(result.data, result.tjrq);
                    } else {
                        NotificationHelper.warning(result.message || 'è¯¥ä½“æ£€IDæœªæ‰¾åˆ°å¯¹åº”çš„ä»ªå™¨å®¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ä½“æ£€IDæ˜¯å¦æ­£ç¡®', 'æ•°æ®æœªæ‰¾åˆ°');
                    }
                }

                // å…³é—­åŠ è½½æç¤º
                if (loadingNotification) {
                    loadingNotification.remove();
                }

            } catch (error) {
                const departmentName = selectedDepartment === 'laboratory' ? 'æ£€éªŒç§‘' :
                              selectedDepartment === 'general' ? 'å¸¸è§„ç§‘å®¤' :
                              selectedDepartment === 'imaging' ? 'å½±åƒç§‘å®¤' : 'ä»ªå™¨å®¤';
                console.error(`è·å–${departmentName}æ•°æ®å¤±è´¥:`, error);
                // å…³é—­åŠ è½½æç¤º
                if (loadingNotification) {
                    loadingNotification.remove();
                }

                if (error.message.includes('fetch')) {
                    NotificationHelper.networkError(`æ— æ³•è¿æ¥åˆ°${departmentName}æ•°æ®æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯äººå‘˜`, () => {
                        getHealthResults(); // é‡è¯•å‡½æ•°
                    });
                } else {
                    NotificationHelper.error(`è·å–${departmentName}æ•°æ®å¤±è´¥: ` + error.message, 'æ•°æ®è·å–é”™è¯¯');
                }
            }
        }

        // è°ƒé˜…ä½“æ£€ä¿¡æ¯
        async function lookupExaminationData() {
            const identityCard = document.getElementById('customerIdentityCard').value;
            const selectedDepartment = window.selectedDepartmentType;

            if (!identityCard) {
                showNotification('error', 'è¯·å…ˆé€‰æ‹©æ£€å®¢');
                return;
            }

            if (!selectedDepartment) {
                showNotification('error', 'è¯·å…ˆé€‰æ‹©ç§‘å®¤ç±»å‹');
                return;
            }

            showNotification('info', 'æ­£åœ¨è·å–ä½“æ£€IDåˆ—è¡¨...');

            try {
                // è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–ä½“æ£€IDåˆ—è¡¨
                const examIdsUrl = `${window.EXAMINATION_API_CONFIG.baseURL}/examination-ids/${identityCard}`;

                const response = await fetch(examIdsUrl, {
                    method: 'GET',
                    headers: window.EXAMINATION_API_CONFIG.headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.code === 200 && result.data) {
                    await showExaminationIdSelectionModal(result.data, identityCard, selectedDepartment);
                } else {
                    showNotification(result.message || 'æœªæŸ¥è¯¢åˆ°ä½“æ£€IDåˆ—è¡¨', 'warning');
                }

            } catch (error) {
                console.error('è·å–ä½“æ£€IDåˆ—è¡¨å¤±è´¥:', error);
                showNotification('è·å–ä½“æ£€IDåˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºä½“æ£€IDé€‰æ‹©æ¨¡æ€æ¡†
        async function showExaminationIdSelectionModal(examinationIds, identityCard, departmentType) {
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) return;

            const departmentNames = {
                'laboratory': 'æ£€éªŒç§‘',
                'general': 'å¸¸è§„ç§‘å®¤',
                'imaging': 'å½±åƒç§‘å®¤',
                'instrument': 'ä»ªå™¨å®¤'
            };

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-semibold text-gray-900">
                                    <i class="fas fa-list mr-2 text-blue-600"></i>
                                    é€‰æ‹©ä½“æ£€ID - ${departmentNames[departmentType]}
                                </h3>
                                <button onclick="closeExaminationIdSelectionModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                èº«ä»½è¯å·: ${identityCard} | æ‰¾åˆ° ${examinationIds.length} ä¸ªä½“æ£€ID
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="examinationIdsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-96 overflow-y-auto">
                                <!-- ä½“æ£€IDåˆ—è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸²æŸ“ä½“æ£€IDåˆ—è¡¨
            renderExaminationIdsList(examinationIds, identityCard, departmentType);
        }

        // æ¸²æŸ“ä½“æ£€IDåˆ—è¡¨
        function renderExaminationIdsList(examinationIds, identityCard, departmentType) {
            const listContainer = document.getElementById('examinationIdsList');
            if (!listContainer) return;

            if (examinationIds.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">æœªæŸ¥è¯¢åˆ°ä½“æ£€ID</div>';
                return;
            }

            listContainer.innerHTML = examinationIds.map(examId => {
                const examIdElementId = `examId_${examId}`;
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-colors"
                         onclick="selectExaminationId('${examId}', '${identityCard}', '${departmentType}')"
                         title="ç‚¹å‡»é€‰æ‹©æ­¤ä½“æ£€ID">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-file-medical text-2xl text-blue-500 mb-2"></i>
                            <span class="font-mono text-sm font-medium text-gray-800">${examId}</span>
                            <div id="${examIdElementId}" class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-spinner fa-spin mr-1"></i>éªŒè¯ä¸­...
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // è‡ªåŠ¨éªŒè¯æ‰€æœ‰ä½“æ£€ID
            examinationIds.forEach(examId => {
                validateExaminationIdInModal(examId, departmentType);
            });
        }

        // éªŒè¯æ¨¡æ€æ¡†ä¸­çš„ä½“æ£€ID
        async function validateExaminationIdInModal(examId, departmentType) {
            const examIdElementId = `examId_${examId}`;
            const validationElement = document.getElementById(examIdElementId);

            if (!validationElement) return;

            try {
                // æ ¹æ®ç§‘å®¤ç±»å‹é€‰æ‹©æ­£ç¡®çš„APIç«¯ç‚¹
                let checkUrl;
                if (departmentType === 'laboratory') {
                    checkUrl = `${CONFIG.api.baseURL}/laboratory-data/check-exam-id/${examId}`;
                } else {
                    // è·å–å½“å‰é€‰æ‹©çš„å…·ä½“ç§‘å®¤åç§°ï¼ˆç°åœ¨æ‰€æœ‰è°ƒç”¨éƒ½ç¡®ä¿å·²é€‰æ‹©ç§‘å®¤ï¼‰
                    const actualDepartmentName = getActualDepartmentName(departmentType);
                    checkUrl = `${CONFIG.api.baseURL}/health-assessments/check-exam-id/${examId}?departmentType=${encodeURIComponent(actualDepartmentName)}`;
                }

                const response = await fetch(checkUrl);

                // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸéªŒè¯é€»è¾‘
                if (!response.ok && response.status === 404) {
                    await simulateValidationInModal(examId, departmentType, validationElement);
                    return;
                }

                const result = await response.json();

                if (result.status === 'Success') {
                    if (result.data.exists) {
                        validationElement.innerHTML = `
                            <span class="text-red-600 font-medium">
                                <i class="fas fa-times-circle mr-1"></i>å·²æœ‰æ•°æ®
                            </span>
                        `;
                        validationElement.parentElement.parentElement.classList.add('bg-red-50', 'border-red-300');
                        validationElement.parentElement.parentElement.classList.remove('hover:bg-blue-50', 'hover:border-blue-300');
                    } else {
                        validationElement.innerHTML = `
                            <span class="text-green-600 font-medium">
                                <i class="fas fa-check-circle mr-1"></i>æ— æ•°æ®
                            </span>
                        `;
                    }
                } else {
                    throw new Error(result.message || 'éªŒè¯å¤±è´¥');
                }
            } catch (error) {
                console.error('éªŒè¯ä½“æ£€IDå¤±è´¥:', error);
                // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸéªŒè¯é€»è¾‘
                if (error.message.includes('404') || error.message.includes('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')) {
                    await simulateValidationInModal(examId, departmentType, validationElement);
                } else {
                    validationElement.innerHTML = `
                        <span class="text-yellow-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>éªŒè¯å¤±è´¥
                        </span>
                    `;
                }
            }
        }

        // æ¨¡æ‹Ÿæ¨¡æ€æ¡†ä¸­çš„éªŒè¯é€»è¾‘ï¼ˆä¸´æ—¶ä½¿ç”¨ï¼‰
        async function simulateValidationInModal(examId, selectedDepartment, validationElement) {
            // æ¨¡æ‹ŸéªŒè¯å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 300));

            let isExisting = false;

            try {
                // æ ¹æ®ç§‘å®¤ç±»å‹é€‰æ‹©æ­£ç¡®çš„APIç«¯ç‚¹
                let checkUrl;
                if (selectedDepartment === 'laboratory') {
                    checkUrl = `${CONFIG.api.baseURL}/laboratory-data/check-exam-id/${examId}`;
                } else {
                    // ä½¿ç”¨å®é™…ç§‘å®¤åç§°è€Œä¸æ˜¯ç§‘å®¤ç±»å‹
                    const actualDepartmentName = getActualDepartmentName(selectedDepartment);
                    checkUrl = `${CONFIG.api.baseURL}/health-assessments/check-exam-id/${examId}?departmentType=${encodeURIComponent(actualDepartmentName)}`;
                }

                const response = await fetch(checkUrl);

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'Success' && result.data.exists) {
                        isExisting = true;
                    }
                }
            } catch (error) {
                console.log('éªŒè¯ä½“æ£€IDå¤±è´¥:', error.message);
                // å¦‚æœAPIéªŒè¯å¤±è´¥ï¼Œå‡è®¾æ— æ•°æ®ï¼ˆå…è®¸é€‰æ‹©ï¼‰
            }

            if (isExisting) {
                validationElement.innerHTML = `
                    <span class="text-red-600 font-medium">
                        <i class="fas fa-times-circle mr-1"></i>å·²æœ‰æ•°æ®
                    </span>
                `;
                validationElement.parentElement.parentElement.classList.add('bg-red-50', 'border-red-300');
                validationElement.parentElement.parentElement.classList.remove('hover:bg-blue-50', 'hover:border-blue-300');
            } else {
                validationElement.innerHTML = `
                    <span class="text-green-600 font-medium">
                        <i class="fas fa-check-circle mr-1"></i>æ— æ•°æ®
                    </span>
                `;
            }
        }

        // é€‰æ‹©ä½“æ£€ID
        async function selectExaminationId(examId, identityCard, departmentType) {
            try {
                // æ ¹æ®ç§‘å®¤ç±»å‹é€‰æ‹©æ­£ç¡®çš„APIç«¯ç‚¹
                let checkUrl;
                if (departmentType === 'laboratory') {
                    checkUrl = `${CONFIG.api.baseURL}/laboratory-data/check-exam-id/${examId}`;
                } else {
                    const actualDepartmentName = getActualDepartmentName(departmentType);
                checkUrl = `${CONFIG.api.baseURL}/health-assessments/check-exam-id/${examId}?departmentType=${encodeURIComponent(actualDepartmentName)}`;
                }

                const response = await fetch(checkUrl);
                let isExisting = false;

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'Success' && result.data.exists) {
                        isExisting = true;
                    }
                }

                if (isExisting) {
                    // ä½“æ£€IDå·²å­˜åœ¨ï¼Œä¸å…è®¸é€‰æ‹©
                    showNotification('error', `è¯¥ä½“æ£€IDåœ¨${getDepartmentDisplayName(departmentType)}ä¸­å·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ä½“æ£€ID`);
                    return;
                }
            } catch (error) {
                console.log('APIéªŒè¯å¤±è´¥ï¼Œå…è®¸é€‰æ‹©ä½“æ£€ID:', error.message);
                // å¦‚æœAPIéªŒè¯å¤±è´¥ï¼Œå…è®¸é€‰æ‹©ï¼ˆé¿å…ç¡¬ç¼–ç å¯¼è‡´çš„æ— æ³•é€‰æ‹©é—®é¢˜ï¼‰
            }

            // å¡«å……ä½“æ£€IDåˆ°è¾“å…¥æ¡†
            document.getElementById('medicalExamId').value = examId;

            // å…³é—­æ¨¡æ€æ¡†
            closeExaminationIdSelectionModal();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('success', `å·²é€‰æ‹©ä½“æ£€ID: ${examId}`);

            // æ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€
            updateLookupExamButton();
        }

        // å…³é—­ä½“æ£€IDé€‰æ‹©æ¨¡æ€æ¡†
        function closeExaminationIdSelectionModal() {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
        }

        // æ ¹æ®ç§‘å®¤ç±»å‹è·å–API URL
        async function getExaminationApiUrl(departmentType, identityCard, examId) {
            const baseUrl = window.EXAMINATION_API_CONFIG.baseURL;

            switch (departmentType) {
                case 'laboratory':
                    // æ£€éªŒç§‘API
                    return `${baseUrl}/laboratory/examination/${examId}?identityCard=${identityCard}`;
                case 'general':
                    // å¸¸è§„ç§‘å®¤API
                    return `${baseUrl}/general/examination/${examId}?identityCard=${identityCard}`;
                case 'imaging':
                    // å½±åƒç§‘å®¤API
                    return `${baseUrl}/imaging/examination/${examId}?identityCard=${identityCard}`;
                case 'instrument':
                    // ä»ªå™¨å®¤API
                    return `${baseUrl}/instrument/examination/${examId}?identityCard=${identityCard}`;
                default:
                    throw new Error('æœªçŸ¥çš„ç§‘å®¤ç±»å‹');
            }
        }

        // æ˜¾ç¤ºä½“æ£€æ•°æ®æ¨¡æ€æ¡†
        async function showExaminationDataModal(data, departmentType, examId) {
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) return;

            const departmentNames = {
                'laboratory': 'æ£€éªŒç§‘',
                'general': 'å¸¸è§„ç§‘å®¤',
                'imaging': 'å½±åƒç§‘å®¤',
                'instrument': 'ä»ªå™¨å®¤'
            };

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-semibold text-gray-900">
                                    <i class="fas fa-stethoscope mr-2 text-purple-600"></i>
                                    ä½“æ£€ä¿¡æ¯è°ƒé˜… - ${departmentNames[departmentType]}
                                </h3>
                                <button onclick="closeExaminationDataModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                ä½“æ£€ID: ${examId} | ç§‘å®¤: ${departmentNames[departmentType]}
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="examinationDataContent">
                                <!-- ä½“æ£€æ•°æ®å†…å®¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="flex justify-end space-x-3">
                                    ${departmentType === 'laboratory' ? `
                                        <button onclick="importExaminationData('${examId}', '${departmentType}')"
                                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                            <i class="fas fa-cloud-download-alt mr-2"></i>è·å–æ£€éªŒæ•°æ®
                                        </button>
                                    ` : `
                                        <button onclick="importExaminationData('${examId}', '${departmentType}')"
                                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-download mr-2"></i>å¯¼å…¥æ•°æ®
                                        </button>
                                    `}
                                    <button onclick="closeExaminationDataModal()"
                                            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                        å…³é—­
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸²æŸ“ä½“æ£€æ•°æ®å†…å®¹
            await renderExaminationDataContent(data, departmentType);
        }

        // æ¸²æŸ“ä½“æ£€æ•°æ®å†…å®¹
        async function renderExaminationDataContent(data, departmentType) {
            const contentContainer = document.getElementById('examinationDataContent');
            if (!contentContainer) return;

            let content = '';

            switch (departmentType) {
                case 'laboratory':
                    content = renderLaboratoryData(data);
                    break;
                case 'general':
                    content = renderGeneralData(data);
                    break;
                case 'imaging':
                    content = renderImagingData(data);
                    break;
                case 'instrument':
                    content = renderInstrumentData(data);
                    break;
                default:
                    content = '<div class="text-center text-gray-500 py-8">æœªçŸ¥ç§‘å®¤ç±»å‹</div>';
            }

            contentContainer.innerHTML = content;
        }

        // æ¸²æŸ“æ£€éªŒç§‘æ•°æ®
        function renderLaboratoryData(data) {
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3">æ£€éªŒç»“æœ</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å¸¸è§„ç§‘å®¤æ•°æ®
        function renderGeneralData(data) {
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3">æ£€æŸ¥é¡¹ç›®ç»“æœ</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å½±åƒç§‘å®¤æ•°æ®
        function renderImagingData(data) {
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3">å½±åƒæ£€æŸ¥ç»“æœ</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ä»ªå™¨å®¤æ•°æ®
        function renderInstrumentData(data) {
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3">ä»ªå™¨æ£€æŸ¥ç»“æœ</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // å…³é—­ä½“æ£€æ•°æ®æ¨¡æ€æ¡†
        function closeExaminationDataModal() {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
        }

        // å¯¼å…¥ä½“æ£€æ•°æ®
        async function importExaminationData(examId, departmentType) {
            if (departmentType === 'laboratory') {
                await importLaboratoryData(examId);
            } else {
                showNotification('info', 'è¯¥ç§‘å®¤æ•°æ®å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­...');
            }
        }

        // å¯¼å…¥æ£€éªŒç§‘æ•°æ®
        async function importLaboratoryData(examId) {
            showNotification('info', 'æ­£åœ¨è·å–æ£€éªŒç§‘æ•°æ®...');

            try {
                // è°ƒç”¨æ£€éªŒç§‘APIè·å–æ•°æ®
                const response = await fetch(`${window.EXAMINATION_API_CONFIG.baseURL}/query_laboratory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...window.EXAMINATION_API_CONFIG.headers
                    },
                    body: JSON.stringify({
                        studyId: examId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.code === 200 && result.data) {
                    await fillLaboratoryDataForm(result.data);
                    closeExaminationDataModal();
                    showNotification('success', `å·²æˆåŠŸå¯¼å…¥ ${result.data.length} é¡¹æ£€éªŒæ•°æ®`);
                } else {
                    showNotification(result.message || 'æœªè·å–åˆ°æ£€éªŒæ•°æ®', 'warning');
                }

            } catch (error) {
                console.error('è·å–æ£€éªŒç§‘æ•°æ®å¤±è´¥:', error);
                showNotification('è·å–æ£€éªŒç§‘æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¡«å……æ£€éªŒç§‘æ•°æ®è¡¨å• - é‡å†™ç‰ˆæœ¬
        async function fillLaboratoryDataForm(laboratoryData, tjrq) {
            console.log('ğŸ”„ å¼€å§‹æ–°çš„fillLaboratoryDataFormè°ƒç”¨');
            console.log('ğŸ“Š æ¥æ”¶æ•°æ®:', laboratoryData.length, 'æ¡è®°å½•');
            console.log('ğŸ“… æ¥æ”¶tjrqå‚æ•°:', tjrq);

            // ç¡®ä¿æ˜¾ç¤ºå¥åº·æ•°æ®å½•å…¥åŒºåŸŸ
            const entryArea = document.getElementById('healthDataEntryArea');
            if (entryArea) {
                entryArea.classList.remove('hidden');
                entryArea.style.display = 'block';
            }

            // å½»åº•æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºå®¹å™¨
            const container = document.getElementById('labTestItems');
            container.innerHTML = '';

            // ç¡®ä¿å®¹å™¨å®Œå…¨æ¸…ç©º
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            console.log('ğŸ§¹ å®¹å™¨å·²æ¸…ç©º');

            // ä¸ºæ¯æ¡æ•°æ®åˆ›å»ºä¸€ä¸ªå¡ç‰‡ï¼Œä¸è¿›è¡Œåˆ†ç»„
            laboratoryData.forEach((item, index) => {
                console.log(`ğŸ“‹ åˆ›å»ºå¡ç‰‡ ${index + 1}/${laboratoryData.length}: ${item.XXMC}`);

                // ç¡®å®šå¼‚å¸¸çŠ¶æ€
                let abnormalStatus = '0'; // æ­£å¸¸
                if (item.Flag === 2) {
                    abnormalStatus = '2'; // åé«˜
                } else if (item.Flag === 1) {
                    abnormalStatus = '1'; // åä½
                }

                // åˆ›å»ºå”¯ä¸€çš„å¡ç‰‡ID
                const itemId = 'lab_' + Date.now() + '_' + index;

                // ç›´æ¥åˆ›å»ºHTMLå­—ç¬¦ä¸²
                const itemHtml = `
                    <div id="${itemId}" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-700">${item.SFXMMC || 'æ£€éªŒé¡¹ç›®'}</h4>
                            <button type="button" onclick="removeLabTestItem('${itemId}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">æ£€éªŒåç§°</label>
                                <input type="text" name="testName" value="${item.SFXMMC || ''} - ${item.XXMC || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">æ£€éªŒç»“æœ</label>
                                <input type="text" name="testResult" value="${item.ItemResult || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">å‚è€ƒå€¼</label>
                                <input type="text" name="referenceValue" value="${item.DefValue || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">å¼‚å¸¸çŠ¶æ€</label>
                                <select name="abnormalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="0" ${abnormalStatus === '0' ? 'selected' : ''}>æ­£å¸¸</option>
                                    <option value="1" ${abnormalStatus === '1' ? 'selected' : ''}>åä½</option>
                                    <option value="2" ${abnormalStatus === '2' ? 'selected' : ''}>åé«˜</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">å•ä½</label>
                                <input type="text" name="unit" value="${item.ItemUnit || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">æ£€æŸ¥åŒ»ç”Ÿ</label>
                                <input type="text" name="doctor" value="${item.Doctor || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°å®¹å™¨
                container.insertAdjacentHTML('beforeend', itemHtml);
                console.log(`âœ… å¡ç‰‡ ${index + 1} å·²åˆ›å»º`);
            });

            // å¡«å……æ£€æŸ¥æ—¥æœŸï¼ˆä½¿ç”¨ä¼ å…¥çš„tjrqå‚æ•°ï¼‰
            if (tjrq) {
                const checkDateInput = document.getElementById('examDate');
                if (checkDateInput) {
                    // æ ¼å¼åŒ–tjrqæ—¥æœŸä¸ºYYYY-MM-DDæ ¼å¼
                    const tjrqDate = new Date(tjrq);
                    // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                    const year = tjrqDate.getFullYear();
                    const month = String(tjrqDate.getMonth() + 1).padStart(2, '0');
                    const day = String(tjrqDate.getDate()).padStart(2, '0');
                    const formattedDate = `${year}-${month}-${day}`;
                    checkDateInput.value = formattedDate;
                    console.log('ğŸ“… ä½¿ç”¨tjrqå‚æ•°å¡«å……ä½“æ£€æ—¥æœŸ:', formattedDate, 'åŸå§‹tjrq:', tjrq);
                }
            }

            console.log(`ğŸ‰ å®Œæˆï¼åˆ›å»ºäº† ${laboratoryData.length} ä¸ªæ£€éªŒé¡¹ç›®å¡ç‰‡`);
        }

        // å¡«å……å¸¸è§„ç§‘å®¤æ•°æ®è¡¨å•
        async function fillGeneralDepartmentForm(generalData) {
            console.log('ğŸ”„ å¼€å§‹fillGeneralDepartmentFormè°ƒç”¨');
            console.log('ğŸ“Š æ¥æ”¶å¸¸è§„ç§‘å®¤æ•°æ®:', generalData.length, 'æ¡è®°å½•');

            // ç¡®ä¿æ˜¾ç¤ºå¥åº·æ•°æ®å½•å…¥åŒºåŸŸ
            const entryArea = document.getElementById('healthDataEntryArea');
            if (entryArea) {
                entryArea.classList.remove('hidden');
                entryArea.style.display = 'block';
            }

            // å½»åº•æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºå®¹å™¨
            const container = document.getElementById('generalAssessmentItems');
            container.innerHTML = '';

            // ç¡®ä¿å®¹å™¨å®Œå…¨æ¸…ç©º
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            console.log('ğŸ§¹ å¸¸è§„ç§‘å®¤å®¹å™¨å·²æ¸…ç©º');

            // å¤„ç†å®é™…APIè¿”å›çš„æ•°æ®ç»“æ„
            // å®é™…æ•°æ®æ ¼å¼ï¼š{StudyID: "...", èƒ¸å»“: "æœªè§å¼‚å¸¸", è‚º: "åŒè‚ºå‘¼å¸éŸ³æ¸…æ™°", ...}
            let assessmentItems = [];

            if (generalData.length > 0) {
                const dataItem = generalData[0]; // å–ç¬¬ä¸€æ¡è®°å½•

                // éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œæ’é™¤ç©ºå€¼å’Œç³»ç»Ÿå­—æ®µ
                Object.keys(dataItem).forEach(key => {
                    const value = dataItem[key];

                    // è·³è¿‡StudyIDã€å°ç»“ã€å…¶ä»–ç­‰ç³»ç»Ÿå­—æ®µå’Œç©ºå€¼
                    if (key !== 'StudyID' && key !== 'å°ç»“' && key !== 'å…¶ä»–' &&
                        value !== null && value !== undefined && value !== '') {
                        assessmentItems.push({
                            itemName: key,
                            itemResult: value
                        });
                    }
                });
            }

            console.log('ğŸ“‹ è§£æåçš„è¯„ä¼°é¡¹ç›®:', assessmentItems);

            // ä¸ºæ¯ä¸ªè¯„ä¼°é¡¹ç›®åˆ›å»ºä¸€ä¸ªå¡ç‰‡
            assessmentItems.forEach((item, index) => {
                console.log(`ğŸ“‹ åˆ›å»ºå¸¸è§„ç§‘å®¤å¡ç‰‡ ${index + 1}/${assessmentItems.length}: ${item.itemName}`);

                // åˆ›å»ºå”¯ä¸€çš„å¡ç‰‡ID
                const itemId = 'general_' + Date.now() + '_' + index;

                // ç›´æ¥åˆ›å»ºHTMLå­—ç¬¦ä¸²
                const itemHtml = `
                    <div id="${itemId}" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-700">${item.itemName || 'è¯„ä¼°é¡¹ç›®'}</h4>
                            <button type="button" onclick="removeGeneralAssessmentItem('${itemId}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">é¡¹ç›®åç§°</label>
                                <input type="text" name="itemName" value="${item.itemName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">é¡¹ç›®ç»“æœ</label>
                                <input type="text" name="itemResult" value="${item.itemResult}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°å®¹å™¨
                container.insertAdjacentHTML('beforeend', itemHtml);
                console.log(`âœ… å¸¸è§„ç§‘å®¤å¡ç‰‡ ${index + 1} å·²åˆ›å»º`);
            });

            console.log(`ğŸ‰ å¸¸è§„ç§‘å®¤å®Œæˆï¼åˆ›å»ºäº† ${assessmentItems.length} ä¸ªè¯„ä¼°é¡¹ç›®å¡ç‰‡`);
        }

        // å¡«å……å½±åƒç§‘å®¤è¡¨å•æ•°æ®
        async function fillImagingDepartmentForm(imagingData, examDate) {
            console.log('ğŸ”„ å¼€å§‹fillImagingDepartmentFormè°ƒç”¨');
            console.log('ğŸ“Š æ¥æ”¶å½±åƒç§‘å®¤æ•°æ®:', imagingData.length, 'æ¡è®°å½•');
            console.log('ğŸ“… ä½“æ£€æ—¥æœŸ:', examDate);

            // ç¡®ä¿æ˜¾ç¤ºå¥åº·æ•°æ®å½•å…¥åŒºåŸŸ
            const entryArea = document.getElementById('healthDataEntryArea');
            if (entryArea) {
                entryArea.classList.remove('hidden');
            }

            // å¡«å……ä½“æ£€æ—¥æœŸï¼ˆå¦‚æœæä¾›äº†æ—¥æœŸï¼‰
            if (examDate) {
                const examDateInput = document.getElementById('examDate');
                if (examDateInput) {
                    // å°†ISOæ—¥æœŸæ ¼å¼è½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼
                    const date = new Date(examDate);
                    const formattedDate = date.toISOString().split('T')[0];
                    examDateInput.value = formattedDate;
                    console.log('ğŸ“… å·²å¡«å……ä½“æ£€æ—¥æœŸ:', formattedDate);
                }
            }

            // å½±åƒç§‘å®¤APIè¿”å›çš„æ•°æ®ç»“æ„ï¼š
            // [
            //   {
            //     "StudyID": "2401110282",
            //     "Doctor": "éƒè‰³é¦™",
            //     "æ£€æŸ¥ç»“è®º": "è¯¦ç»†çš„æ£€æŸ¥ç»“è®º...",
            //     "æ£€æŸ¥æè¿°": "è¯¦ç»†çš„æ£€æŸ¥æè¿°..."
            //   }
            // ]

            if (imagingData.length > 0) {
                // åˆå¹¶æ‰€æœ‰è®°å½•çš„æ£€æŸ¥æè¿°å’Œç»“è®º
                let combinedDescription = '';
                let combinedConclusion = '';
                let doctorName = '';

                imagingData.forEach((record, index) => {
                    console.log(`ğŸ“‹ å¤„ç†è®°å½• ${index + 1}:`, {
                        StudyID: record.StudyID,
                        hasDoctor: !!record['åŒ»ç”Ÿ'],
                        hasDescription: !!record['æ£€æŸ¥æè¿°'],
                        hasConclusion: !!record['æ£€æŸ¥ç»“è®º']
                    });

                    // åˆå¹¶æ£€æŸ¥æè¿°
                    if (record['æ£€æŸ¥æè¿°']) {
                        if (combinedDescription) {
                            combinedDescription += '\n\n' + '='.repeat(50) + '\n\n';
                        }
                        combinedDescription += record['æ£€æŸ¥æè¿°'];
                    }

                    // åˆå¹¶æ£€æŸ¥ç»“è®º
                    if (record['æ£€æŸ¥ç»“è®º']) {
                        if (combinedConclusion) {
                            combinedConclusion += '\n\n';
                        }
                        combinedConclusion += record['æ£€æŸ¥ç»“è®º'];
                    }

                    // è®¾ç½®åŒ»ç”Ÿå§“åï¼ˆä»¥æœ€åä¸€æ¡è®°å½•çš„åŒ»ç”Ÿä¸ºå‡†ï¼‰
                    if (record['åŒ»ç”Ÿ']) {
                        doctorName = record['åŒ»ç”Ÿ'];
                    }
                });

                // å¡«å……è¡¨å•å­—æ®µ
                const doctorNameInput = document.getElementById('imagingDoctorName');
                if (doctorNameInput && doctorName) {
                    doctorNameInput.value = doctorName;
                    console.log('ğŸ‘¨â€âš•ï¸ å·²å¡«å……å½±åƒç§‘åŒ»ç”Ÿå§“å:', doctorName);
                }

                const descriptionTextarea = document.getElementById('examDescription');
                if (descriptionTextarea) {
                    descriptionTextarea.value = combinedDescription;
                    console.log('ğŸ“ å·²å¡«å……æ£€æŸ¥æè¿°ï¼Œé•¿åº¦:', combinedDescription.length, 'å­—ç¬¦');
                }

                const conclusionTextarea = document.getElementById('examConclusion');
                if (conclusionTextarea) {
                    conclusionTextarea.value = combinedConclusion;
                    console.log('ğŸ“‹ å·²å¡«å……æ£€æŸ¥ç»“è®ºï¼Œé•¿åº¦:', combinedConclusion.length, 'å­—ç¬¦');
                }

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                NotificationHelper.success(`å½±åƒç§‘å®¤æ•°æ®å¡«å……å®Œæˆï¼ŒåŒ…å« ${imagingData.length} æ¡æ£€æŸ¥è®°å½•`, 'æ•°æ®å¡«å……æˆåŠŸ');

            } else {
                NotificationHelper.warning('å½±åƒç§‘å®¤æ•°æ®ä¸ºç©ºï¼Œæ— æ³•å¡«å……è¡¨å•', 'æ•°æ®ä¸ºç©º');
            }

            console.log('ğŸ‰ å½±åƒç§‘å®¤æ•°æ®å¡«å……å®Œæˆï¼');
        }

        // å¡«å……ä»ªå™¨å®¤æ•°æ®è¡¨å•
        async function fillInstrumentRoomForm(instrumentData, examDate) {
            console.log('ğŸ”„ å¼€å§‹fillInstrumentRoomFormè°ƒç”¨');
            console.log('ğŸ“Š æ¥æ”¶ä»ªå™¨å®¤æ•°æ®:', instrumentData.length, 'æ¡è®°å½•');
            console.log('ğŸ“… ä½“æ£€æ—¥æœŸ:', examDate);

            // ç¡®ä¿æ˜¾ç¤ºå¥åº·æ•°æ®å½•å…¥åŒºåŸŸ
            const entryArea = document.getElementById('healthDataEntryArea');
            if (entryArea) {
                entryArea.classList.remove('hidden');
            }

            // å¡«å……ä½“æ£€æ—¥æœŸï¼ˆå¦‚æœæä¾›äº†æ—¥æœŸï¼‰
            if (examDate) {
                const instrumentDateInput = document.getElementById('instrumentDate');
                if (instrumentDateInput) {
                    // å°†ISOæ—¥æœŸæ ¼å¼è½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼
                    const date = new Date(examDate);
                    const formattedDate = date.toISOString().split('T')[0];
                    instrumentDateInput.value = formattedDate;
                    console.log('ğŸ“… å·²å¡«å……ä»ªå™¨å®¤æ£€æŸ¥æ—¥æœŸ:', formattedDate);
                }
            }

            // ä»ªå™¨å®¤APIè¿”å›çš„æ•°æ®ç»“æ„ï¼š
            // [
            //   {
            //     "StudyID": "2301110023",
            //     "æ£€æŸ¥ç»“æœ": "æ­£å¸¸å¿ƒç”µå›¾"
            //   }
            // ]

            if (instrumentData.length > 0) {
                // åˆå¹¶æ‰€æœ‰è®°å½•çš„æ£€æŸ¥ç»“æœ
                let combinedResult = '';
                let doctorName = '';

                instrumentData.forEach((record, index) => {
                    console.log(`ğŸ“‹ å¤„ç†è®°å½• ${index + 1}:`, {
                        StudyID: record.StudyID,
                        hasResult: !!record['æ£€æŸ¥ç»“æœ'],
                        hasDoctor: !!record['åŒ»ç”Ÿ']
                    });

                    // åˆå¹¶æ£€æŸ¥ç»“æœ
                    if (record['æ£€æŸ¥ç»“æœ']) {
                        if (combinedResult) {
                            combinedResult += '\n\n' + '='.repeat(50) + '\n\n';
                        }
                        combinedResult += record['æ£€æŸ¥ç»“æœ'];
                    }

                    // è®¾ç½®åŒ»ç”Ÿå§“åï¼ˆä»¥æœ€åä¸€æ¡è®°å½•çš„åŒ»ç”Ÿä¸ºå‡†ï¼‰
                    if (record['åŒ»ç”Ÿ']) {
                        doctorName = record['åŒ»ç”Ÿ'];
                    }
                });

                // å¡«å……è¡¨å•å­—æ®µ
                const resultTextarea = document.getElementById('instrumentResult');
                if (resultTextarea) {
                    resultTextarea.value = combinedResult;
                    console.log('ğŸ“ å·²å¡«å……æ£€æŸ¥ç»“æœï¼Œé•¿åº¦:', combinedResult.length, 'å­—ç¬¦');
                }

                // å¡«å……åŒ»ç”Ÿå§“å
                const doctorInput = document.getElementById('instrumentDoctor');
                if (doctorInput && doctorName) {
                    doctorInput.value = doctorName;
                    console.log('ğŸ‘¨â€âš•ï¸ å·²å¡«å……åŒ»ç”Ÿå§“å:', doctorName);
                }

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                NotificationHelper.success(`ä»ªå™¨å®¤æ•°æ®å¡«å……å®Œæˆï¼ŒåŒ…å« ${instrumentData.length} æ¡æ£€æŸ¥è®°å½•`, 'æ•°æ®å¡«å……æˆåŠŸ');

            } else {
                NotificationHelper.warning('ä»ªå™¨å®¤æ•°æ®ä¸ºç©ºï¼Œæ— æ³•å¡«å……è¡¨å•', 'æ•°æ®ä¸ºç©º');
            }

            console.log('ğŸ‰ ä»ªå™¨å®¤æ•°æ®å¡«å……å®Œæˆï¼');
        }

        // ä¿å­˜å¸¸è§„ç§‘å®¤æ•°æ®åˆ°åç«¯
        async function saveGeneralDepartmentDataToBackend() {
            if (!window.selectedCustomerId) {
                NotificationHelper.validationError('è¯·å…ˆé€‰æ‹©æ£€å®¢ï¼Œç„¶åå†ä¿å­˜å¸¸è§„ç§‘å®¤æ•°æ®');
                return;
            }

            const examId = document.getElementById('medicalExamId').value;
            const assessmentDate = document.getElementById('assessmentDate').value;
            const doctorName = document.getElementById('generalDoctorName').value;
            const departmentSelect = document.getElementById('departmentSelect');
            const selectedDepartmentId = departmentSelect.value;
            const selectedDepartmentName = departmentSelect.options[departmentSelect.selectedIndex]?.text || '';

            if (!examId || !assessmentDate || !selectedDepartmentId) {
                NotificationHelper.validationError('è¯·å¡«å†™å®Œæ•´çš„å¸¸è§„ç§‘å®¤ä¿¡æ¯ï¼šä½“æ£€IDã€è¯„ä¼°æ—¥æœŸå’Œç§‘å®¤éƒ½æ˜¯å¿…å¡«é¡¹');
                return;
            }

            // æ”¶é›†å¸¸è§„ç§‘å®¤é¡¹ç›®æ•°æ®
            const generalItems = document.querySelectorAll('#generalAssessmentItems .border');
            if (generalItems.length === 0) {
                NotificationHelper.validationError('è¯·å…ˆæ·»åŠ è¯„ä¼°é¡¹ç›®æˆ–è·å–ä½“æ£€ç»“æœï¼Œç„¶åå†ä¿å­˜æ•°æ®');
                return;
            }

            const assessmentItems = [];
            let incompleteItems = 0;

            generalItems.forEach((item, index) => {
                const itemName = item.querySelector('input[name="itemName"]')?.value;
                const itemResult = item.querySelector('input[name="itemResult"]')?.value;

                if (itemName && itemResult) {
                    assessmentItems.push({
                        itemName,
                        itemResult,
                        departmentName: selectedDepartmentName,
                        departmentId: selectedDepartmentId
                    });
                } else if (itemName || itemResult) {
                    incompleteItems++;
                }
            });

            if (assessmentItems.length === 0) {
                NotificationHelper.validationError('æ‰€æœ‰è¯„ä¼°é¡¹ç›®éƒ½ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼ˆé¡¹ç›®åç§°å’Œé¡¹ç›®ç»“æœï¼‰ï¼Œè¯·å®Œå–„åé‡è¯•');
                return;
            }

            if (incompleteItems > 0) {
                NotificationHelper.warning(`å‘ç° ${incompleteItems} ä¸ªä¸å®Œæ•´çš„è¯„ä¼°é¡¹ç›®å·²è·³è¿‡ï¼Œåªä¿å­˜å®Œæ•´çš„é¡¹ç›®`, 'æ•°æ®éªŒè¯è­¦å‘Š');
            }

            const savingNotification = NotificationHelper.saving(`æ­£åœ¨ä¿å­˜ ${assessmentItems.length} é¡¹å¸¸è§„ç§‘å®¤æ•°æ®åˆ°æ•°æ®åº“...`);

            try {
                const response = await fetch(`${CONFIG.api.baseURL}/health-assessments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        customerId: window.selectedCustomerId,
                        medicalExamId: examId,
                        assessmentDate,
                        department: selectedDepartmentName,
                        doctor: doctorName,
                        assessmentData: assessmentItems,
                        summary: `å¸¸è§„ç§‘å®¤è¯„ä¼° - ${selectedDepartmentName} - å…±${assessmentItems.length}é¡¹`
                    })
                });

                const result = await response.json();

                // å…³é—­ä¿å­˜æç¤º
                if (savingNotification) {
                    savingNotification.remove();
                }

                if (result.status === 'Success') {
                    NotificationHelper.complete(`æˆåŠŸä¿å­˜ ${assessmentItems.length} é¡¹å¸¸è§„ç§‘å®¤æ•°æ®ï¼Œä½“æ£€ID: ${examId}`, 'ä¿å­˜æˆåŠŸ');

                    // æ›´æ–°æ£€å®¢æœ€åä½“æ£€æ—¥æœŸ
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        await window.API.customer.updateLastHealthCheckDate(window.selectedCustomerIdentityCard, today);
                        console.log('âœ… æ£€å®¢æœ€åä½“æ£€æ—¥æœŸå·²æ›´æ–°');

                        // åˆ·æ–°ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢åˆ—è¡¨
                        loadTodayCustomers();
                    } catch (updateError) {
                        console.warn('âš ï¸ æ›´æ–°æœ€åä½“æ£€æ—¥æœŸå¤±è´¥:', updateError);
                    }

                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    setTimeout(() => {
                        NotificationHelper.tip(`æ•°æ®å·²ä¿å­˜åˆ°ç³»ç»Ÿä¸­ï¼Œæ£€å®¢å¯ä»¥åœ¨æŸ¥è¯¢é¡µé¢æŸ¥çœ‹è¿™äº›å¸¸è§„ç§‘å®¤ç»“æœ`, 'æ“ä½œæç¤º');
                    }, 1000);

                    // æ¸…ç©ºè¡¨å•
                    clearGeneralForm();
                } else {
                    if (result.message && result.message.includes('å­˜åœ¨')) {
                        NotificationHelper.error(result.message, 'æ•°æ®é‡å¤é”™è¯¯', true);
                    } else {
                        NotificationHelper.error(result.message || 'å¸¸è§„ç§‘å®¤æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'ä¿å­˜å¤±è´¥');
                    }
                }

            } catch (error) {
                console.error('ä¿å­˜å¸¸è§„ç§‘å®¤æ•°æ®å¤±è´¥:', error);
                // å…³é—­ä¿å­˜æç¤º
                if (savingNotification) {
                    savingNotification.remove();
                }

                if (error.message.includes('fetch') || error.message.includes('network')) {
                    NotificationHelper.networkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¿å­˜æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', () => {
                        saveGeneralDepartmentDataToBackend(); // é‡è¯•å‡½æ•°
                    });
                } else if (error.message.includes('500')) {
                    NotificationHelper.databaseError('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯äººå‘˜');
                } else {
                    NotificationHelper.error('ä¿å­˜å¸¸è§„ç§‘å®¤æ•°æ®å¤±è´¥: ' + error.message, 'ä¿å­˜é”™è¯¯');
                }
            }
        }

        // ä¿å­˜å½±åƒç§‘å®¤æ•°æ®åˆ°åç«¯
        async function saveImagingDepartmentDataToBackend() {
            if (!window.selectedCustomerId) {
                NotificationHelper.validationError('è¯·å…ˆé€‰æ‹©æ£€å®¢ï¼Œç„¶åå†ä¿å­˜å½±åƒç§‘å®¤æ•°æ®');
                return;
            }

            const examId = document.getElementById('medicalExamId').value;
            const examDate = document.getElementById('examDate').value;
            const doctorName = document.getElementById('imagingDoctorName').value;
            const examDescription = document.getElementById('examDescription').value;
            const examConclusion = document.getElementById('examConclusion').value;
            const departmentSelect = document.getElementById('departmentSelect');
            const selectedDepartmentId = departmentSelect.value;
            const selectedDepartmentName = departmentSelect.options[departmentSelect.selectedIndex]?.text || '';

            if (!examId || !examDate || !doctorName || !examDescription || !examConclusion || !selectedDepartmentId) {
                NotificationHelper.validationError('è¯·å¡«å†™å®Œæ•´çš„å½±åƒç§‘å®¤ä¿¡æ¯ï¼šä½“æ£€IDã€æ£€æŸ¥æ—¥æœŸã€åŒ»ç”Ÿã€æ£€æŸ¥æè¿°ã€æ£€æŸ¥ç»“è®ºå’Œç§‘å®¤éƒ½æ˜¯å¿…å¡«é¡¹');
                return;
            }

            const loadingNotification = NotificationHelper.saving('æ­£åœ¨ä¿å­˜å½±åƒç§‘å®¤æ•°æ®ï¼Œè¯·ç¨å€™...');

            try {
                // æ„å»ºå½±åƒç§‘å®¤æ•°æ®ç»“æ„
                const imagingData = {
                    customerId: window.selectedCustomerId,
                    assessmentDate: examDate,
                    department: selectedDepartmentName,
                    doctor: doctorName,
                    assessmentData: [
                        {
                            itemName: 'æ£€æŸ¥æè¿°',
                            itemResult: examDescription,
                            departmentName: selectedDepartmentName,
                            departmentId: selectedDepartmentId
                        },
                        {
                            itemName: 'æ£€æŸ¥ç»“è®º',
                            itemResult: examConclusion,
                            departmentName: selectedDepartmentName,
                            departmentId: selectedDepartmentId
                        }
                    ],
                    summary: `å½±åƒç§‘å®¤è¯„ä¼° - ${selectedDepartmentName}`,
                    medicalExamId: examId,
                    createdBy: window.userId || 'system'
                };

                console.log('ğŸ”„ å‡†å¤‡ä¿å­˜å½±åƒç§‘å®¤æ•°æ®:', imagingData);

                // è°ƒç”¨APIä¿å­˜æ•°æ®
                const response = await window.API.imagingDepartment.saveImagingDepartmentData(imagingData);

                if (response.ok) {
                    const result = await response.json();

                    if (result.status === 'Success') {
                        NotificationHelper.success('å½±åƒç§‘å®¤æ•°æ®ä¿å­˜æˆåŠŸï¼', 'ä¿å­˜æˆåŠŸ');

                        // æ›´æ–°æ£€å®¢æœ€åä½“æ£€æ—¥æœŸ
                        try {
                            const today = new Date().toISOString().split('T')[0];
                            await window.API.customer.updateLastHealthCheckDate(window.selectedCustomerIdentityCard, today);
                            console.log('âœ… æ£€å®¢æœ€åä½“æ£€æ—¥æœŸå·²æ›´æ–°');

                            // åˆ·æ–°ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢åˆ—è¡¨
                            loadTodayCustomers();
                        } catch (updateError) {
                            console.warn('âš ï¸ æ›´æ–°æœ€åä½“æ£€æ—¥æœŸå¤±è´¥:', updateError);
                        }

                        // æ¸…ç©ºè¡¨å•ï¼ˆå¯é€‰ï¼‰
                        document.getElementById('imagingHealthForm').reset();

                        console.log('âœ… å½±åƒç§‘å®¤æ•°æ®ä¿å­˜æˆåŠŸ:', result.data);
                    } else {
                        throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('ä¿å­˜å½±åƒç§‘å®¤æ•°æ®å¤±è´¥:', error);

                if (error.message.includes('fetch')) {
                    NotificationHelper.networkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¿å­˜å½±åƒç§‘å®¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•', () => {
                        saveImagingDepartmentDataToBackend(); // é‡è¯•å‡½æ•°
                    });
                } else if (error.message.includes('500')) {
                    NotificationHelper.databaseError('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯äººå‘˜');
                } else {
                    NotificationHelper.error('ä¿å­˜å½±åƒç§‘å®¤æ•°æ®å¤±è´¥: ' + error.message, 'ä¿å­˜é”™è¯¯');
                }
            } finally {
                // å…³é—­åŠ è½½æç¤º
                if (loadingNotification) {
                    loadingNotification.remove();
                }
            }
        }

        // ä¿å­˜ä»ªå™¨å®¤æ•°æ®åˆ°åç«¯
        async function saveInstrumentRoomDataToBackend() {
            if (!window.selectedCustomerId) {
                NotificationHelper.validationError('è¯·å…ˆé€‰æ‹©æ£€å®¢ï¼Œç„¶åå†ä¿å­˜ä»ªå™¨å®¤æ•°æ®');
                return;
            }

            const examId = document.getElementById('medicalExamId').value;
            const instrumentDate = document.getElementById('instrumentDate').value;
            const doctorName = document.getElementById('instrumentDoctor').value;
            const instrumentResult = document.getElementById('instrumentResult').value;
            const departmentSelect = document.getElementById('departmentSelect');
            const selectedDepartmentId = departmentSelect.value;
            const selectedDepartmentName = departmentSelect.options[departmentSelect.selectedIndex]?.text || '';

            if (!examId || !instrumentDate || !instrumentResult || !selectedDepartmentId) {
                NotificationHelper.validationError('è¯·å¡«å†™å®Œæ•´çš„ä»ªå™¨å®¤ä¿¡æ¯ï¼šä½“æ£€IDã€æ£€æŸ¥æ—¥æœŸã€æ£€æŸ¥ç»“æœå’Œç§‘å®¤éƒ½æ˜¯å¿…å¡«é¡¹');
                return;
            }

            const loadingNotification = NotificationHelper.saving('æ­£åœ¨ä¿å­˜ä»ªå™¨å®¤æ•°æ®ï¼Œè¯·ç¨å€™...');

            try {
                // æ„å»ºä»ªå™¨å®¤æ•°æ®ç»“æ„
                const instrumentData = {
                    customerId: window.selectedCustomerId,
                    assessmentDate: instrumentDate,
                    department: selectedDepartmentName,
                    doctor: doctorName,
                    assessmentData: [
                        {
                            itemName: 'æ£€æŸ¥ç»“æœ',
                            itemResult: instrumentResult,
                            departmentName: selectedDepartmentName,
                            departmentId: selectedDepartmentId
                        }
                    ],
                    summary: `ä»ªå™¨å®¤è¯„ä¼° - ${selectedDepartmentName}`,
                    medicalExamId: examId,
                    createdBy: window.userId || 'system'
                };

                console.log('ğŸ”„ å‡†å¤‡ä¿å­˜ä»ªå™¨å®¤æ•°æ®:', instrumentData);

                // è°ƒç”¨APIä¿å­˜æ•°æ®
                const response = await window.API.instrumentRoom.saveInstrumentRoomData(instrumentData);

                if (response.ok) {
                    const result = await response.json();

                    if (result.status === 'Success') {
                        NotificationHelper.success('ä»ªå™¨å®¤æ•°æ®ä¿å­˜æˆåŠŸï¼', 'ä¿å­˜æˆåŠŸ');

                        // æ›´æ–°æ£€å®¢æœ€åä½“æ£€æ—¥æœŸ
                        try {
                            const today = new Date().toISOString().split('T')[0];
                            await window.API.customer.updateLastHealthCheckDate(window.selectedCustomerIdentityCard, today);
                            console.log('âœ… æ£€å®¢æœ€åä½“æ£€æ—¥æœŸå·²æ›´æ–°');

                            // åˆ·æ–°ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢åˆ—è¡¨
                            loadTodayCustomers();
                        } catch (updateError) {
                            console.warn('âš ï¸ æ›´æ–°æœ€åä½“æ£€æ—¥æœŸå¤±è´¥:', updateError);
                        }

                        // æ¸…ç©ºè¡¨å•ï¼ˆå¯é€‰ï¼‰
                        document.getElementById('instrumentHealthForm').reset();

                        console.log('âœ… ä»ªå™¨å®¤æ•°æ®ä¿å­˜æˆåŠŸ:', result.data);
                    } else {
                        throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('ä¿å­˜ä»ªå™¨å®¤æ•°æ®å¤±è´¥:', error);

                if (error.message.includes('fetch')) {
                    NotificationHelper.networkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¿å­˜ä»ªå™¨å®¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•', () => {
                        saveInstrumentRoomDataToBackend(); // é‡è¯•å‡½æ•°
                    });
                } else if (error.message.includes('500')) {
                    NotificationHelper.databaseError('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯äººå‘˜');
                } else {
                    NotificationHelper.error('ä¿å­˜ä»ªå™¨å®¤æ•°æ®å¤±è´¥: ' + error.message, 'ä¿å­˜é”™è¯¯');
                }
            } finally {
                // å…³é—­åŠ è½½æç¤º
                if (loadingNotification) {
                    loadingNotification.remove();
                }
            }
        }

        // ä¿å­˜æ£€éªŒç§‘æ•°æ®åˆ°åç«¯
        async function saveLaboratoryDataToBackend() {
            if (!window.selectedCustomerId) {
                NotificationHelper.validationError('è¯·å…ˆé€‰æ‹©æ£€å®¢ï¼Œç„¶åå†ä¿å­˜æ£€éªŒæ•°æ®');
                return;
            }

            const examId = document.getElementById('medicalExamId').value;
            const checkDate = document.getElementById('examDate').value;

            if (!examId || !checkDate) {
                NotificationHelper.validationError('è¯·å¡«å†™å®Œæ•´çš„ä½“æ£€ä¿¡æ¯ï¼šä½“æ£€IDå’Œæ£€éªŒæ—¥æœŸéƒ½æ˜¯å¿…å¡«é¡¹');
                return;
            }

            // æ”¶é›†æ£€éªŒé¡¹ç›®æ•°æ®
            const labTestItems = document.querySelectorAll('#labTestItems .border');
            if (labTestItems.length === 0) {
                NotificationHelper.validationError('è¯·å…ˆæ·»åŠ æ£€éªŒé¡¹ç›®æˆ–è·å–ä½“æ£€ç»“æœï¼Œç„¶åå†ä¿å­˜æ•°æ®');
                return;
            }

            const laboratoryItems = [];
            let incompleteItems = 0;

            labTestItems.forEach((item, index) => {
                const testName = item.querySelector('input[name="testName"]')?.value;
                const testResult = item.querySelector('input[name="testResult"]')?.value;
                const referenceValue = item.querySelector('input[name="referenceValue"]')?.value;
                const abnormalStatus = item.querySelector('select[name="abnormalStatus"]')?.value;
                const unit = item.querySelector('input[name="unit"]')?.value;
                const doctor = item.querySelector('input[name="doctor"]')?.value;

                if (testName && testResult) {
                    laboratoryItems.push({
                        testCategory: 'æ£€éªŒç§‘æ•°æ®',
                        testName,
                        testResult,
                        referenceValue,
                        abnormalFlag: abnormalStatus,
                        unit,
                        doctor: doctor || ''
                    });
                } else if (testName || testResult) {
                    incompleteItems++;
                }
            });

            if (laboratoryItems.length === 0) {
                NotificationHelper.validationError('æ‰€æœ‰æ£€éªŒé¡¹ç›®éƒ½ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼ˆæ£€éªŒåç§°å’Œæ£€éªŒç»“æœï¼‰ï¼Œè¯·å®Œå–„åé‡è¯•');
                return;
            }

            if (incompleteItems > 0) {
                NotificationHelper.warning(`å‘ç° ${incompleteItems} ä¸ªä¸å®Œæ•´çš„æ£€éªŒé¡¹ç›®å·²è·³è¿‡ï¼Œåªä¿å­˜å®Œæ•´çš„é¡¹ç›®`, 'æ•°æ®éªŒè¯è­¦å‘Š');
            }

            const savingNotification = NotificationHelper.saving(`æ­£åœ¨ä¿å­˜ ${laboratoryItems.length} é¡¹æ£€éªŒæ•°æ®åˆ°æ•°æ®åº“...`);

            try {
                const response = await fetch(`${CONFIG.api.baseURL}/laboratory-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        customerId: window.selectedCustomerId,
                        examId,
                        checkDate,
                        laboratoryItems,
                        doctor: ''
                    })
                });

                const result = await response.json();

                // å…³é—­ä¿å­˜æç¤º
                if (savingNotification) {
                    savingNotification.remove();
                }

                if (result.status === 'Success') {
                    NotificationHelper.complete(`æˆåŠŸä¿å­˜ ${laboratoryItems.length} é¡¹æ£€éªŒæ•°æ®ï¼Œä½“æ£€ID: ${examId}`, 'ä¿å­˜æˆåŠŸ');

                    // æ›´æ–°æ£€å®¢æœ€åä½“æ£€æ—¥æœŸ
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        await window.API.customer.updateLastHealthCheckDate(window.selectedCustomerIdentityCard, today);
                        console.log('âœ… æ£€å®¢æœ€åä½“æ£€æ—¥æœŸå·²æ›´æ–°');

                        // åˆ·æ–°ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢åˆ—è¡¨
                        loadTodayCustomers();
                    } catch (updateError) {
                        console.warn('âš ï¸ æ›´æ–°æœ€åä½“æ£€æ—¥æœŸå¤±è´¥:', updateError);
                    }

                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    setTimeout(() => {
                        NotificationHelper.tip(`æ•°æ®å·²ä¿å­˜åˆ°ç³»ç»Ÿä¸­ï¼Œæ£€å®¢å¯ä»¥åœ¨æŸ¥è¯¢é¡µé¢æŸ¥çœ‹è¿™äº›æ£€éªŒç»“æœ`, 'æ“ä½œæç¤º');
                    }, 1000);

                    // æ¸…ç©ºè¡¨å•
                    clearLabForm();
                } else {
                    if (result.message && result.message.includes('å­˜åœ¨')) {
                        NotificationHelper.error(result.message, 'æ•°æ®é‡å¤é”™è¯¯', true);
                    } else {
                        NotificationHelper.error(result.message || 'æ£€éªŒç§‘æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'ä¿å­˜å¤±è´¥');
                    }
                }

            } catch (error) {
                console.error('ä¿å­˜æ£€éªŒç§‘æ•°æ®å¤±è´¥:', error);
                // å…³é—­ä¿å­˜æç¤º
                if (savingNotification) {
                    savingNotification.remove();
                }

                if (error.message.includes('fetch') || error.message.includes('network')) {
                    NotificationHelper.networkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¿å­˜æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', () => {
                        saveLaboratoryDataToBackend(); // é‡è¯•å‡½æ•°
                    });
                } else if (error.message.includes('500')) {
                    NotificationHelper.databaseError('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯äººå‘˜');
                } else {
                    NotificationHelper.error('ä¿å­˜æ£€éªŒç§‘æ•°æ®å¤±è´¥: ' + error.message, 'ä¿å­˜é”™è¯¯');
                }
            }
        }

    
        // è·å–ç§‘å®¤æ˜¾ç¤ºåç§°
        function getDepartmentDisplayName(departmentType) {
            const departmentNames = {
                'laboratory': 'æ£€éªŒç§‘',
                'general': 'å¸¸è§„ç§‘å®¤',
                'imaging': 'å½±åƒç§‘å®¤',
                'instrument': 'ä»ªå™¨å®¤'
            };
            return departmentNames[departmentType] || 'æœªçŸ¥ç§‘å®¤';
        }

        // è·å–å®é™…çš„ç§‘å®¤åç§°ç”¨äºAPIè°ƒç”¨
        function getActualDepartmentName(departmentType) {
            // ä»ç§‘å®¤é€‰æ‹©ä¸‹æ‹‰æ¡†ä¸­è·å–å½“å‰é€‰ä¸­çš„å®é™…ç§‘å®¤åç§°
            const departmentSelect = document.getElementById('departmentSelect');
            if (departmentSelect && departmentSelect.selectedIndex > 0) {
                return departmentSelect.options[departmentSelect.selectedIndex].text;
            }

            // å¦‚æœæ— æ³•ä»é€‰æ‹©æ¡†è·å–ï¼Œä½¿ç”¨é»˜è®¤æ˜ å°„
            const actualNames = {
                'laboratory': 'æ£€éªŒç§‘',
                'general': 'å†…ç§‘', // å¸¸è§„ç§‘å®¤é»˜è®¤ä¸ºå†…ç§‘
                'imaging': 'å½±åƒç§‘',
                'instrument': 'ä»ªå™¨å®¤'
            };
            return actualNames[departmentType] || departmentType;
        }

        // å¯ç”¨/ç¦ç”¨è°ƒé˜…æŒ‰é’®
        function updateLookupExamButton() {
            const identityCard = document.getElementById('customerIdentityCard').value;
            const departmentSelect = document.getElementById('departmentSelect');
            const lookupBtn = document.getElementById('lookupExamBtn');

            // è°ƒé˜…æŒ‰é’®éœ€è¦èº«ä»½è¯å·å’Œå·²é€‰æ‹©çš„å…·ä½“ç§‘å®¤æ‰èƒ½å¯ç”¨
            const hasSelectedDepartment = departmentSelect && departmentSelect.selectedIndex > 0;

            if (identityCard && window.selectedDepartmentType && hasSelectedDepartment) {
                lookupBtn.disabled = false;
                lookupBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                lookupBtn.textContent = 'è°ƒé˜…';
                lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i>è°ƒé˜…';
            } else {
                lookupBtn.disabled = true;
                lookupBtn.classList.add('opacity-50', 'cursor-not-allowed');

                // æ ¹æ®ç¼ºå¤±çš„æ¡ä»¶æ˜¾ç¤ºä¸åŒçš„æç¤ºæ–‡æœ¬
                if (!identityCard) {
                    lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i>è¯·å…ˆè¾“å…¥èº«ä»½è¯å·';
                } else if (!window.selectedDepartmentType) {
                    lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i>è¯·å…ˆé€‰æ‹©ç§‘å®¤ç±»å‹';
                } else if (!hasSelectedDepartment) {
                    lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i>è¯·å…ˆé€‰æ‹©å…·ä½“ç§‘å®¤';
                } else {
                    lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i>è°ƒé˜…';
                }
            }
        }

        // åŠ è½½ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢
        async function loadTodayCustomers() {
            try {
                console.log('ğŸ”„ æ­£åœ¨åŠ è½½ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢...');
                const response = await window.API.customer.getTodayHealthChecks();

                if (response.status === 'Success') {
                    // ç¡®ä¿customersæ˜¯æ•°ç»„
                    let customers = response.data || [];

                    // å¦‚æœè¿”å›çš„ä¸æ˜¯æ•°ç»„ï¼Œå°è¯•æå–recordset
                    if (!Array.isArray(customers) && customers.recordset) {
                        customers = customers.recordset;
                    }

                    // å¦‚æœä»ç„¶ä¸æ˜¯æ•°ç»„ï¼Œè®¾ä¸ºç©ºæ•°ç»„
                    if (!Array.isArray(customers)) {
                        console.warn('è¿”å›çš„æ•°æ®æ ¼å¼å¼‚å¸¸:', response.data);
                        customers = [];
                    }

                    const tableBody = document.getElementById('todayCustomersTableBody');
                    const noDataMessage = document.getElementById('noTodayCustomersMessage');

                    if (customers.length === 0) {
                        tableBody.innerHTML = '';
                        noDataMessage.classList.remove('hidden');
                        console.log('â„¹ï¸ ä»Šæ—¥æš‚æ— æ–°å¢ä½“æ£€æ£€å®¢');
                    } else {
                        noDataMessage.classList.add('hidden');
                        let tableHtml = '';

                        customers.forEach(customer => {
                            const createdDate = customer.CreatedAt ?
                                new Date(customer.CreatedAt).toLocaleString('zh-CN', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : '-';

                            tableHtml += `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.IdentityCard || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.Name || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.Gender || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.Age || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.Phone || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${createdDate}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <button onclick="selectTodayCustomer('${customer.IdentityCard}', '${customer.Name}', '${customer.ID}')"
                                                class="text-blue-600 hover:text-blue-800 font-medium">
                                            é€‰æ‹©
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableBody.innerHTML = tableHtml;
                        console.log(`âœ… æˆåŠŸåŠ è½½ ${customers.length} ä½ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢`);
                    }
                } else {
                    console.error('âŒ è·å–ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢å¤±è´¥:', response.message);
                    const noDataMessage = document.getElementById('noTodayCustomersMessage');
                    noDataMessage.classList.remove('hidden');
                    document.getElementById('todayCustomersTableBody').innerHTML = '';
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢æ—¶å‘ç”Ÿé”™è¯¯:', error);
                const noDataMessage = document.getElementById('noTodayCustomersMessage');
                noDataMessage.classList.remove('hidden');
                document.getElementById('todayCustomersTableBody').innerHTML = '';
            }
        }

        // é€‰æ‹©ä»Šæ—¥æ£€å®¢
        function selectTodayCustomer(identityCard, name, customerId) {
            console.log(`ğŸ‘¤ é€‰æ‹©ä»Šæ—¥æ£€å®¢: ${name} (${identityCard})`);

            // å¡«å……æ£€å®¢ä¿¡æ¯
            document.getElementById('customerIdentityCard').value = identityCard;
            window.selectedCustomerId = customerId;
            window.selectedCustomerIdentityCard = identityCard;

            // æ˜¾ç¤ºæ£€å®¢ä¿¡æ¯
            const selectedInfo = document.getElementById('selectedCustomerInfo');
            if (selectedInfo) {
                selectedInfo.classList.remove('hidden');
                selectedInfo.querySelector('span').textContent = `å·²é€‰æ‹©: ${name} (${identityCard})`;
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            NotificationHelper.success(`å·²é€‰æ‹©æ£€å®¢: ${name}`, 'é€‰æ‹©æˆåŠŸ');

            // æ›´æ–°è°ƒé˜…æŒ‰é’®çŠ¶æ€
            updateLookupExamButton();
        }

        // åˆ·æ–°ä»Šæ—¥æ£€å®¢åˆ—è¡¨
        function refreshTodayCustomers() {
            loadTodayCustomers();
            NotificationHelper.info('ä»Šæ—¥æ£€å®¢åˆ—è¡¨å·²åˆ·æ–°', 'åˆ·æ–°å®Œæˆ');
        }

        // æ¸…ç©ºè¡¨å•å‡½æ•°
        function clearLabForm() {
            document.getElementById('labHealthForm').reset();
            document.getElementById('labTestItems').innerHTML = '';
        }

        function clearGeneralForm() {
            document.getElementById('generalHealthForm').reset();
            document.getElementById('generalAssessmentItems').innerHTML = '';
        }

        function clearImagingForm() {
            document.getElementById('imagingHealthForm').reset();
        }

        function clearInstrumentForm() {
            document.getElementById('instrumentHealthForm').reset();
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸä¸ºé»˜è®¤å€¼
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // åŠ è½½ä»Šæ—¥æ–°å¢ä½“æ£€æ£€å®¢
            loadTodayCustomers();

            // æ·»åŠ æ£€éªŒç§‘è¡¨å•æäº¤äº‹ä»¶å¤„ç†å™¨
            const labHealthForm = document.getElementById('labHealthForm');
            if (labHealthForm) {
                labHealthForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveLaboratoryDataToBackend();
                });
            }

            // æ·»åŠ å…¶ä»–è¡¨å•æäº¤äº‹ä»¶å¤„ç†å™¨
            const generalHealthForm = document.getElementById('generalHealthForm');
            if (generalHealthForm) {
                generalHealthForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveGeneralDepartmentDataToBackend();
                });
            }

            const imagingHealthForm = document.getElementById('imagingHealthForm');
            if (imagingHealthForm) {
                imagingHealthForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveImagingDepartmentDataToBackend();
                });
            }

            const instrumentHealthForm = document.getElementById('instrumentHealthForm');
            if (instrumentHealthForm) {
                instrumentHealthForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveInstrumentRoomDataToBackend();
                });
            }
        });
    </script>
</body>
</html>