# 系统配置指南

## 概述

本文档详细说明了干细胞治疗档案管理系统的配置方法，包括开发环境、测试环境和生产环境的配置指南。

## 配置文件结构

```
backend/
├── .env                  # 开发环境配置文件（不提交到版本控制）
├── .env.example         # 配置模板文件
└── config/
    ├── database.js      # 数据库配置
    └── config.js        # 应用配置

frontend/
└── config.js            # 前端配置文件
```

## 后端环境配置

### 环境变量说明

#### 1. 服务器配置
```bash
NODE_ENV=development          # 环境类型：development/production
PORT=5000                    # 后端服务端口
HOST=localhost                # 后端服务主机地址
```

#### 2. 数据库配置
```bash
DB_USER=sa                   # 数据库用户名
DB_PASSWORD=your_password     # 数据库密码
DB_SERVER=localhost          # 数据库服务器地址
DB_DATABASE=HealthRecordSystem  # 数据库名称
DB_ENCRYPT=true              # 连接加密
DB_TRUST_CERTIFICATE=true    # 信任证书
```

#### 3. 第三方体检API配置
```bash
EXAMINATION_API_HOST=localhost      # 第三方API主机
EXAMINATION_API_PORT=3000           # 第三方API端口
EXAMINATION_API_BASE_URL=http://localhost:3000/api  # 完整API地址
```

#### 4. 前端URL配置
```bash
FRONTEND_HOST=localhost      # 前端服务主机
FRONTEND_PORT=8080          # 前端服务端口
FRONTEND_URL=http://localhost:8080  # 完整前端地址
```

#### 5. JWT认证配置
```bash
JWT_SECRET=your-secret-key   # JWT密钥（生产环境必须修改）
JWT_EXPIRES_IN=7d           # Token过期时间
```

#### 6. 文件上传配置
```bash
UPLOAD_DIR=uploads          # 上传文件目录
MAX_FILE_SIZE=10485760      # 最大文件大小（字节）
```

#### 7. AI服务配置
```bash
DEEPSEEK_API_KEY=your_api_key          # DeepSeek API密钥
DEEPSEEK_BASE_URL=https://api.deepseek.com  # DeepSeek API地址
DEEPSEEK_MODEL=deepseek-chat           # 使用的模型
```

#### 8. PDF转换服务配置
```bash
# 方式1：完整URL配置（推荐）
PDF_CONVERT_URL=http://localhost:4000/convert

# 方式2：分离配置
PDF_HOST=localhost          # PDF服务主机
PDF_PORT=4000              # PDF服务端口
PDF_CONVERT_TIMEOUT=30000  # 转换超时时间（毫秒）
```

#### 9. 业务配置
```bash
COMPARISON_REPORT_MAX_SELECTIONS=3  # 对比报告最大选择数量
```

### 环境配置示例

#### 开发环境 (.env.development)
```bash
NODE_ENV=development
PORT=5000
HOST=localhost

# 数据库
DB_SERVER=localhost
DB_DATABASE=HealthRecordSystem_Dev

# 第三方API
EXAMINATION_API_BASE_URL=http://localhost:3000/api

# 前端
FRONTEND_URL=http://localhost:8080

# PDF服务
PDF_CONVERT_URL=http://localhost:4000/convert
```

#### 生产环境 (.env.production)
```bash
NODE_ENV=production
PORT=5000
HOST=0.0.0.0

# 数据库
DB_SERVER=prod-db-server
DB_DATABASE=HealthRecordSystem_Prod

# 第三方API
EXAMINATION_API_BASE_URL=https://api.examination-service.com/api

# 前端
FRONTEND_URL=https://health-system.example.com

# PDF服务
PDF_CONVERT_URL=https://pdf-service.example.com/convert

# 安全配置
JWT_SECRET=production-super-secret-key
```

## 前端配置

### 自动配置机制

前端配置文件 `frontend/config.js` 提供了智能的环境检测和配置功能：

#### 1. 主API配置
- **开发环境**：前端在8080端口时，自动连接 `http://localhost:5000/api`
- **生产环境**：使用同域名下的 `/api` 路径

#### 2. 第三方体检API配置
- **开发环境**：自动连接 `http://localhost:3000/api`
- **生产环境**：可通过全局变量自定义

### 自定义配置方法

#### 方法1：修改配置文件
```javascript
// 在 frontend/config.js 中直接修改
const CONFIG = {
    examinationAPI: {
        baseURL: '自定义URL',
        // ...
    }
};
```

#### 方法2：运行时覆盖
```javascript
// 在页面加载后动态设置
window.EXAMINATION_API_CONFIG = {
    baseURL: 'https://your-api-server.com/api',
    timeout: 15000
};
```

## 部署配置指南

### 1. 开发环境设置

#### 步骤1：克隆配置模板
```bash
cd backend
cp .env.example .env
```

#### 步骤2：修改配置
```bash
# 编辑 .env 文件
NODE_ENV=development
PORT=5000
HOST=localhost
# ... 其他配置
```

#### 步骤3：启动服务
```bash
# 启动后端
cd backend
npm run dev

# 启动前端
cd frontend
npx http-server -p 8080
```

### 2. 生产环境设置

#### 步骤1：创建生产环境配置
```bash
cd backend
cp .env.example .env.production
```

#### 步骤2：配置生产环境变量
```bash
NODE_ENV=production
HOST=0.0.0.0
PORT=5000

# 数据库配置（使用真实的生产数据库）
DB_SERVER=your-prod-db-server
DB_USER=your-prod-user
DB_PASSWORD=your-prod-password

# 安全配置（必须修改）
JWT_SECRET=production-secret-key-change-this

# 第三方服务配置
EXAMINATION_API_BASE_URL=https://third-party-api.com/api
PDF_CONVERT_URL=https://pdf-service.com/convert
```

#### 步骤3：部署应用
```bash
# 使用PM2管理进程
pm2 start ecosystem.config.js --env production

# 或直接启动
NODE_ENV=production node server.js
```

### 3. Docker部署配置

#### Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm ci --only=production

# 复制应用代码
COPY . .

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

USER nodejs

EXPOSE 5000

# 使用环境变量启动
CMD ["node", "server.js"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - DB_SERVER=db
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - db
    restart: unless-stopped

  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${DB_PASSWORD}
    volumes:
      - mssql_data:/var/opt/mssql
    restart: unless-stopped

volumes:
  mssql_data:
```

## 安全配置建议

### 1. 必须修改的配置项
- `JWT_SECRET`: 使用强随机字符串
- `DB_PASSWORD`: 使用强密码
- `DEEPSEEK_API_KEY`: 使用您自己的API密钥

### 2. 生产环境安全措施
- 使用HTTPS协议
- 启用防火墙
- 定期更新依赖包
- 配置CORS策略
- 设置日志轮转

### 3. 环境变量管理
- 不要将 `.env` 文件提交到版本控制
- 使用安全的密钥管理服务
- 定期轮换敏感信息

## 故障排除

### 1. 数据库连接失败
```bash
# 检查数据库配置
echo $DB_SERVER
echo $DB_USER
echo $DB_PASSWORD

# 测试连接
telnet $DB_SERVER 1433
```

### 2. API连接失败
```bash
# 检查服务状态
curl http://localhost:5000/api/health
curl http://localhost:3000/api/health
```

### 3. 前端配置问题
```javascript
// 在浏览器控制台检查配置
console.log('API Config:', window.CONFIG);
console.log('Examination API:', window.EXAMINATION_API_CONFIG);
```

## 配置验证脚本

创建一个配置验证脚本 `scripts/validate-config.js`：

```javascript
const requiredEnvVars = [
    'NODE_ENV',
    'PORT',
    'DB_SERVER',
    'DB_DATABASE',
    'JWT_SECRET'
];

const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
    console.error('缺少必需的环境变量:', missingVars);
    process.exit(1);
}

console.log('✅ 配置验证通过');
```

使用方法：
```bash
node scripts/validate-config.js
```

## 更新历史

- **2025-10-08**: 初始版本，包含基础配置指南
- **2025-10-08**: 添加第三方API配置和前端自动配置
- **2025-10-08**: 完善Docker部署和安全配置建议